# E1-S5: Server Verification & E2E Testing

## Story
**As a** developer setting up DevPulse for the first time
**I want** to verify the server starts correctly and all API endpoints work as documented
**So that** I can be confident the foundation is solid before building client features on top of it

## Status
- **Epic**: Core Dashboard Foundation
- **Priority**: P1-High
- **Points**: 2
- **Sprint**: 1
- **Dependencies**: None (tests the existing server implementation)

## Acceptance Criteria
- [ ] AC1: `cd apps/server && bun dev` starts without errors and prints the startup banner showing port 4000
- [ ] AC2: Enricher creates `projects`, `sessions`, and `dev_logs` tables on startup (verified via SQLite inspection)
- [ ] AC3: `POST /events` with a valid SessionStart payload returns 200 and creates a project and session record
- [ ] AC4: `GET /api/projects` returns a JSON array of projects (may be empty initially, populated after sending events)
- [ ] AC5: `GET /api/sessions` returns a JSON array of active sessions
- [ ] AC6: `GET /api/devlogs` returns a JSON array of dev log entries
- [ ] AC7: WebSocket connection at `ws://localhost:4000/stream` accepts connections and sends `initial`, `projects`, and `sessions` messages on connect
- [ ] AC8: All test procedures are documented in a test script that can be re-run

## Technical Notes

### Server Startup Sequence
From `apps/server/src/index.ts`:
1. `initDatabase()` (line 14) - creates `events` table and indexes
2. `initEnricher(getDb())` (line 15) - creates `projects`, `sessions`, `dev_logs` tables (enricher.ts lines 21-78)
3. `setInterval(() => markIdleSessions(), 30000)` (line 18) - idle detection timer
4. `setInterval(() => cleanupOldSessions(), 3600000)` (line 20) - cleanup timer
5. `Bun.serve()` on port 4000 (line 91)

### Test Event Payloads
SessionStart event:
```json
{
  "source_app": "TestProject",
  "session_id": "test-session-001",
  "hook_event_type": "SessionStart",
  "payload": {
    "cwd": "/home/user/projects/test",
    "agent_type": "main"
  },
  "timestamp": 1700000000000
}
```

PostToolUse event (to generate activity):
```json
{
  "source_app": "TestProject",
  "session_id": "test-session-001",
  "hook_event_type": "PostToolUse",
  "payload": {
    "tool_name": "Read",
    "tool_input": {"file_path": "/src/app.ts"},
    "cwd": "/home/user/projects/test"
  },
  "timestamp": 1700000001000
}
```

SessionEnd event (to trigger dev log generation):
```json
{
  "source_app": "TestProject",
  "session_id": "test-session-001",
  "hook_event_type": "SessionEnd",
  "payload": {
    "cwd": "/home/user/projects/test",
    "reason": "user_exit"
  },
  "timestamp": 1700000060000
}
```

### Expected Server Responses
- `POST /events` returns the saved event with an `id` field added
- `GET /api/projects` returns `[{name: "TestProject", path: "/home/user/projects/test", ...}]`
- `GET /api/sessions` returns `[{session_id: "test-session-001", status: "active", ...}]` (empty after SessionEnd)
- `GET /api/devlogs` returns `[{session_id: "test-session-001", project_name: "TestProject", ...}]` after SessionEnd

### WebSocket Verification
On connect, the server sends three messages (index.ts lines 343-351):
1. `{type: 'initial', data: [...events]}`
2. `{type: 'projects', data: [...projects]}`
3. `{type: 'sessions', data: [...sessions]}`

## Tasks
- [ ] Task 1: Create test script at `scripts/test-server.sh` with curl commands that exercise all endpoints
- [ ] Task 2: Start server with `cd apps/server && bun dev` and verify clean startup (no errors, correct port)
- [ ] Task 3: Send a SessionStart event via curl POST and verify 200 response with event ID
- [ ] Task 4: Verify `GET /api/projects` returns the project created by the SessionStart event
- [ ] Task 5: Verify `GET /api/sessions` returns the active session
- [ ] Task 6: Send multiple PostToolUse events, then a SessionEnd event to trigger dev log generation
- [ ] Task 7: Verify `GET /api/devlogs` returns the generated dev log with tool breakdown
- [ ] Task 8: Test WebSocket connection using `websocat ws://localhost:4000/stream` or equivalent and verify initial messages

## Files to Create/Modify
| File | Action | Description |
|------|--------|-------------|
| `scripts/test-server.sh` | Create | Bash script with curl commands to verify all API endpoints |

## Testing
- [ ] Test 1: Server starts on port 4000 without error output
- [ ] Test 2: SQLite database file is created with all expected tables (events, projects, sessions, dev_logs)
- [ ] Test 3: Full event lifecycle works: SessionStart -> PostToolUse x N -> SessionEnd -> verify dev log created
- [ ] Test 4: `GET /api/projects` returns correct project data after events are sent
- [ ] Test 5: `GET /api/devlogs` returns dev log with non-empty tool_breakdown after session ends
- [ ] Test 6: WebSocket sends initial data on connection

## Definition of Done
- [ ] Server starts cleanly with `bun dev`
- [ ] All acceptance criteria verified
- [ ] Test script `scripts/test-server.sh` exists and is executable
- [ ] All curl tests pass with expected responses
- [ ] No server errors in console during test execution
