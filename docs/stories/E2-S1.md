# E2-S1: Session Idle Detection UX

## Story
**As a** developer monitoring active sessions
**I want** idle sessions to visually fade with smooth transitions
**So that** I can instantly distinguish active sessions from idle ones without reading status text

## Status
- **Epic**: Polish & Reliability
- **Priority**: P1-High
- **Points**: 3
- **Sprint**: 2
- **Dependencies**: E1-S3 (useProjects composable must be wired up), E1-S4 (tab navigation must be in place)

## Acceptance Criteria
- [ ] AC1: When a session transitions to `idle` status (no activity for 2 minutes), its row in ProjectOverview fades to 50% opacity with a smooth CSS transition
- [ ] AC2: When an idle session becomes `active` again (receives a new event), it transitions back to full opacity
- [ ] AC3: The session status dot color changes with a transition (green -> gray for active -> idle)
- [ ] AC4: The server broadcasts a `sessions` WebSocket message when idle detection runs, so the client gets real-time idle transitions
- [ ] AC5: Idle transitions use CSS `transition` with ~300ms duration for smooth animation
- [ ] AC6: The idle visual treatment works in both dark and light themes

## Technical Notes

### Server: Idle Detection Broadcasting
The server already runs `markIdleSessions()` every 30 seconds (index.ts line 18). This function (enricher.ts lines 482-496) updates session status from `active` to `idle` when `last_event_at` is older than 2 minutes.

**Missing**: After `markIdleSessions()` runs, the server does NOT currently broadcast the updated sessions to WebSocket clients. The `broadcastProjects()` function (index.ts lines 371-385) only runs when a new event is received (line 134).

**Fix needed**: Add a broadcast after idle detection in the `setInterval` callback (index.ts line 18):
```typescript
// Current (line 18):
setInterval(() => markIdleSessions(), 30000);

// Updated:
setInterval(() => {
  markIdleSessions();
  broadcastProjects(); // This sends both 'projects' and 'sessions' messages
}, 30000);
```

### Client: CSS Transitions in ProjectOverview.vue
The session rows are rendered in `ProjectOverview.vue` lines 82-109. Each session row is a `<div>` inside a `v-for` loop.

Add a CSS transition class to the session row container (line 85):
```html
<!-- Current (line 85): -->
<div class="flex items-center justify-between text-xs bg-[var(--theme-bg-tertiary)] rounded px-2 py-1.5">

<!-- Updated: -->
<div
  class="flex items-center justify-between text-xs bg-[var(--theme-bg-tertiary)] rounded px-2 py-1.5 transition-opacity duration-300"
  :class="{ 'opacity-50': session.status === 'idle' || session.status === 'stopped' }"
>
```

The status dot (lines 89-95) already has conditional classes for `active`, `waiting`, `idle`, and `stopped`. Add `transition-colors duration-300` to the dot span:
```html
<!-- Current (line 89): -->
<span class="w-2 h-2 rounded-full" :class="{...}">

<!-- Updated: -->
<span class="w-2 h-2 rounded-full transition-colors duration-300" :class="{...}">
```

### Project Card Idle Treatment
The project card header badge (lines 24-38) already shows "idle" when `active_sessions` is 0. Consider also adding a subtle opacity change to the entire project card when all its sessions are idle:

```html
<div
  :class="{ 'opacity-75': project.active_sessions === 0 }"
  class="bg-[var(--theme-bg-primary)] rounded-xl border ... transition-opacity duration-300"
>
```

## Tasks
- [ ] Task 1: Modify `apps/server/src/index.ts` line 18 to call `broadcastProjects()` after `markIdleSessions()` in the 30-second interval
- [ ] Task 2: Add `transition-opacity duration-300` class and `:class="{ 'opacity-50': session.status === 'idle' || session.status === 'stopped' }"` to session row div in `ProjectOverview.vue` line 85
- [ ] Task 3: Add `transition-colors duration-300` to the status dot span in `ProjectOverview.vue` line 89
- [ ] Task 4: Add subtle opacity change (`opacity-75`) to the project card container when `project.active_sessions === 0` (line 12-15 of ProjectOverview.vue)
- [ ] Task 5: Verify the transition works by starting a session, waiting 2+ minutes, and observing the fade

## Files to Create/Modify
| File | Action | Description |
|------|--------|-------------|
| `apps/server/src/index.ts` | Modify | Add broadcastProjects() call after markIdleSessions() in setInterval (line 18) |
| `apps/client/src/components/ProjectOverview.vue` | Modify | Add CSS transition classes for opacity and color on session rows and project cards |

## Testing
- [ ] Test 1: Send a SessionStart event, wait 2+ minutes, verify the session row fades to 50% opacity
- [ ] Test 2: After session goes idle, send another event for that session; verify it transitions back to full opacity
- [ ] Test 3: The status dot transitions from green to gray smoothly (not instantly)
- [ ] Test 4: Project cards with no active sessions show subtle opacity reduction
- [ ] Test 5: Verify `broadcastProjects()` is called every 30 seconds by checking WebSocket messages in browser dev tools

## Definition of Done
- [ ] Code compiles without errors
- [ ] All acceptance criteria met
- [ ] No TypeScript errors
- [ ] CSS transitions are smooth (300ms, not jarring)
- [ ] Works in both dark and light themes
- [ ] Server broadcasts session updates on idle detection cycle
