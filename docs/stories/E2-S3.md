# E2-S3: Git Branch Enrichment via Hooks

## Story
**As a** developer using DevPulse
**I want** the current git branch to be automatically detected and sent with every hook event
**So that** the dashboard always shows the correct branch per session without relying on server-side git detection

## Status
- **Epic**: Polish & Reliability
- **Priority**: P2-Medium
- **Points**: 2
- **Sprint**: 2
- **Dependencies**: None (modifies hooks independently)

## Acceptance Criteria
- [ ] AC1: Every hook event sent to the server includes a `git_branch` field in the payload containing the current branch name
- [ ] AC2: Branch detection uses `git branch --show-current` run from the session's `cwd`
- [ ] AC3: If git detection fails (not a git repo, git not installed, timeout), the event is still sent without the `git_branch` field -- no errors, no blocking
- [ ] AC4: Branch detection has a 2-second timeout to avoid slowing down Claude Code hooks
- [ ] AC5: The server enricher correctly reads `git_branch` from the payload (already handled at enricher.ts line 235: `if (payload.git_branch) return payload.git_branch;`)

## Technical Notes

### Current Hook Architecture
All hooks call `send_event.py` via the command line. The individual hook scripts (`pre_tool_use.py`, `post_tool_use.py`, `stop.py`, etc.) read stdin JSON, then call `send_event.py` with arguments.

**However**, looking at `send_event.py` (lines 58-178), the main function reads stdin JSON directly and constructs the event payload. The `cwd` field is already available in `input_data` (line 89: `event_data['payload'] = input_data`), so `input_data['cwd']` contains the working directory.

### Implementation Approach
Add git branch detection directly in `send_event.py` rather than modifying every individual hook script. This centralizes the logic.

In `send_event.py`, after reading `input_data` (line 71) and before constructing `event_data` (line 84):

```python
import subprocess

def get_git_branch(cwd):
    """Get current git branch from working directory. Returns empty string on failure."""
    try:
        result = subprocess.run(
            ['git', 'branch', '--show-current'],
            cwd=cwd,
            capture_output=True,
            text=True,
            timeout=2
        )
        if result.returncode == 0:
            return result.stdout.strip()
    except (subprocess.TimeoutExpired, FileNotFoundError, OSError, Exception):
        pass
    return ''
```

Then add to the payload:
```python
# After line 71 (input_data = json.load(sys.stdin))
cwd = input_data.get('cwd', '')
if cwd:
    branch = get_git_branch(cwd)
    if branch:
        input_data['git_branch'] = branch
```

### Server-Side Reading
The enricher already extracts `git_branch` from the payload at `enricher.ts` line 235:
```typescript
if (payload.git_branch) return payload.git_branch;
```

This means no server changes are needed -- the server will automatically pick up the `git_branch` field from the enriched payload.

### Error Handling
- `subprocess.TimeoutExpired` - git hangs (e.g., network filesystem)
- `FileNotFoundError` - git not installed
- `OSError` - cwd doesn't exist
- All exceptions are caught silently; the hook must never block Claude Code

### Performance
`git branch --show-current` is a fast local operation (typically < 50ms). The 2-second timeout is a safety net. This runs on every hook event, so it should be fast.

## Tasks
- [ ] Task 1: Add `import subprocess` to `apps/server/../.claude/hooks/send_event.py` (near line 5)
- [ ] Task 2: Add `get_git_branch(cwd)` function to `send_event.py` with 2-second timeout and broad exception handling
- [ ] Task 3: Call `get_git_branch()` after reading stdin input (after line 71) and inject `git_branch` into `input_data` before it becomes the event payload
- [ ] Task 4: Verify the server enricher reads `git_branch` from payload (already confirmed at enricher.ts line 235)
- [ ] Task 5: Test by running a hook manually and checking the event payload includes `git_branch`

## Files to Create/Modify
| File | Action | Description |
|------|--------|-------------|
| `.claude/hooks/send_event.py` | Modify | Add get_git_branch() function and call it to inject git_branch into event payload |

## Testing
- [ ] Test 1: From a git repository, send a test event; verify the payload includes `git_branch` with the correct branch name
- [ ] Test 2: From a non-git directory, send a test event; verify the event is sent successfully without `git_branch` field
- [ ] Test 3: Verify the 2-second timeout works by testing (or simulating) a slow git operation -- event should still send without branch
- [ ] Test 4: After sending events with `git_branch`, verify `GET /api/projects` returns the correct `current_branch` value
- [ ] Test 5: Send events from sessions on different branches; verify the project's `current_branch` updates to the latest

## Definition of Done
- [ ] Code runs without errors
- [ ] All acceptance criteria met
- [ ] No hook failures or Claude Code blocking due to git detection
- [ ] Branch detection has 2-second timeout
- [ ] All exceptions caught silently
- [ ] Server correctly reads and stores the branch from hook payload
