# E2-S4: Port Scanning for Dev Servers

## Story
**As a** developer running multiple projects with dev servers
**I want** DevPulse to automatically detect running dev servers by scanning common ports
**So that** the dashboard shows which ports are in use without relying solely on parsing Bash command output

## Status
- **Epic**: Polish & Reliability
- **Priority**: P2-Medium
- **Points**: 3
- **Sprint**: 2
- **Dependencies**: E1-S4 (Projects tab must be wired up to show dev_servers from ProjectOverview.vue)

## Acceptance Criteria
- [ ] AC1: A `scanPorts()` function runs every 60 seconds on the server, scanning common development ports
- [ ] AC2: Ports scanned: 3000-3010, 4000-4010, 5173-5175, 8000-8002, 8080-8082 (30 ports total)
- [ ] AC3: For each responding port, the function detects the server type by checking the HTTP response (look for "vite", "next", "nuxt" etc. in response headers or body)
- [ ] AC4: Detected dev servers are stored in the `dev_servers` JSON field on each project, merged with any servers detected from Bash command parsing (existing `detectDevServers()` at enricher.ts lines 293-334)
- [ ] AC5: When a previously-detected port stops responding, it is removed from the project's `dev_servers` list
- [ ] AC6: Port scanning uses a short timeout (1 second) per port to avoid slowing down the server
- [ ] AC7: Results are broadcast to WebSocket clients so the dashboard updates in real-time

## Technical Notes

### Existing Dev Server Detection
The enricher already detects dev servers from Bash command output (enricher.ts lines 293-334). The `detectDevServers()` function:
1. Watches for `PostToolUse` events with Bash tool
2. Matches commands like `next dev`, `vite`, `bun dev`, etc.
3. Extracts port from stdout (e.g., `localhost:3000`)
4. Updates the project's `dev_servers` JSON field

This is reactive (triggers on events) but misses servers started outside of Claude Code sessions, or servers where the port wasn't captured in stdout.

### Port Scanning Approach
Add a `scanPorts()` function to `enricher.ts` that:

```typescript
const SCAN_PORTS = [
  ...Array.from({length: 11}, (_, i) => 3000 + i),  // 3000-3010
  ...Array.from({length: 11}, (_, i) => 4000 + i),  // 4000-4010
  5173, 5174, 5175,                                   // Vite defaults
  8000, 8001, 8002,                                   // Python/misc
  8080, 8081, 8082,                                   // Java/misc
];

async function scanPorts(): Promise<void> {
  const activeServers: Array<{port: number; type: string}> = [];

  for (const port of SCAN_PORTS) {
    try {
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 1000);

      const response = await fetch(`http://localhost:${port}`, {
        signal: controller.signal,
        method: 'HEAD'  // Lighter than GET
      });
      clearTimeout(timeout);

      if (response.ok || response.status < 500) {
        const type = detectServerType(response, port);
        activeServers.push({ port, type });
      }
    } catch {
      // Port not responding - skip
    }
  }

  // Update all projects with scan results
  updateProjectDevServers(activeServers);
}
```

### Server Type Detection
```typescript
function detectServerType(response: Response, port: number): string {
  const server = response.headers.get('server') || '';
  const powered = response.headers.get('x-powered-by') || '';

  if (server.includes('next') || powered.includes('Next')) return 'next';
  if (server.includes('vite') || port === 5173) return 'vite';
  if (server.includes('nuxt')) return 'nuxt';
  if (port >= 4000 && port <= 4010) return 'bun';  // DevPulse server range
  return 'dev';
}
```

### Merging with Event-Based Detection
The scan results should MERGE with existing event-detected servers, not replace them. Logic:
1. Get current `dev_servers` from each project
2. For scanned ports: add new ones, keep existing ones that are still responding
3. Remove ports that no longer respond AND were added by scanning (not by event detection)

**Simpler approach**: Replace the entire `dev_servers` list with scan results, since scanning is comprehensive. The event-based detection can still add servers between scans.

### Integration into Server
In `index.ts`, add the scan interval:
```typescript
// After line 20:
setInterval(() => {
  scanPorts().then(() => broadcastProjects()).catch(console.error);
}, 60000);

// Also run once on startup after a brief delay:
setTimeout(() => scanPorts().catch(console.error), 5000);
```

### Excluding DevPulse's Own Port
Port 4000 is the DevPulse server itself. Either exclude it from scanning or label it as "devpulse" type. Recommended: exclude port 4000 specifically:
```typescript
if (port === parseInt(process.env.SERVER_PORT || '4000')) continue;
```

### Performance
30 ports x 1s timeout = worst case 30 seconds. But in practice, non-listening ports fail immediately (connection refused), so the scan completes in < 1 second typically. Only hanging/firewalled ports would hit the timeout.

Use `Promise.allSettled()` to scan all ports in parallel for better performance:
```typescript
const results = await Promise.allSettled(
  SCAN_PORTS.map(port => scanSinglePort(port))
);
```

## Tasks
- [ ] Task 1: Add `SCAN_PORTS` constant array and `scanSinglePort(port)` async function to `apps/server/src/enricher.ts`
- [ ] Task 2: Add `detectServerType(response, port)` function that inspects HTTP response headers to determine server type
- [ ] Task 3: Add `scanPorts()` async function that scans all ports in parallel using `Promise.allSettled()` and returns `Array<{port, type}>`
- [ ] Task 4: Add `updateProjectDevServers(servers)` function that updates each project's `dev_servers` field with scan results, merging with existing data
- [ ] Task 5: Export `scanPorts()` from enricher.ts
- [ ] Task 6: Add 60-second interval in `apps/server/src/index.ts` to call `scanPorts()` followed by `broadcastProjects()`
- [ ] Task 7: Add initial scan with 5-second delay after server startup
- [ ] Task 8: Exclude DevPulse's own server port from scanning

## Files to Create/Modify
| File | Action | Description |
|------|--------|-------------|
| `apps/server/src/enricher.ts` | Modify | Add scanPorts(), scanSinglePort(), detectServerType(), updateProjectDevServers() functions |
| `apps/server/src/index.ts` | Modify | Add 60-second setInterval for port scanning and initial delayed scan |

## Testing
- [ ] Test 1: Start a dev server on port 3000 (e.g., `bun serve`), wait 60 seconds, verify it appears in `GET /api/projects` response `dev_servers` field
- [ ] Test 2: Stop the dev server on port 3000, wait 60 seconds, verify it is removed from `dev_servers`
- [ ] Test 3: DevPulse's own port (4000) is NOT listed in any project's `dev_servers`
- [ ] Test 4: Port scan completes in under 5 seconds for all 30 ports
- [ ] Test 5: Vite dev server on port 5173 is correctly identified as type "vite"
- [ ] Test 6: WebSocket clients receive updated project data after port scan completes

## Definition of Done
- [ ] Code compiles without errors (`cd apps/server && bun run build` or `bun dev` starts cleanly)
- [ ] All acceptance criteria met
- [ ] No TypeScript errors
- [ ] Port scanning does not block the event loop (uses async/await with parallel scans)
- [ ] Timeout of 1 second per port prevents hanging
- [ ] DevPulse's own port is excluded
- [ ] Results are broadcast via WebSocket for real-time dashboard updates
