# E3-S1: Vercel Deployment Status Integration

## Story
**As a** developer running multiple projects with Vercel deployments
**I want** to see each project's latest deployment status directly on the project card
**So that** I can monitor CI/CD alongside agent activity without switching to the Vercel dashboard

## Status
- **Epic**: Extended Features
- **Priority**: P2-Medium
- **Points**: 5
- **Sprint**: 5
- **Dependencies**: None (ProjectOverview.vue and Project type already exist)

## Acceptance Criteria
- [ ] AC1: When a project has a Vercel project ID configured, the project card in ProjectOverview.vue shows the latest deployment status (building / ready / error / queued)
- [ ] AC2: Deployment status updates automatically by polling the Vercel API every 30 seconds
- [ ] AC3: The deployment status badge shows a colored indicator: green for "ready", yellow/animated for "building", red for "error", gray for "queued"
- [ ] AC4: Clicking the deployment status badge opens the Vercel deployment URL in a new tab
- [ ] AC5: If no Vercel API token or project ID is configured, the deployment section is hidden gracefully (no errors)
- [ ] AC6: Multiple projects can each have their own Vercel project ID configured
- [ ] AC7: The deployment status includes the deployment age (e.g., "deployed 5m ago") and commit message if available

## Technical Notes

### Architecture
The Vercel integration runs entirely server-side to avoid exposing API tokens to the client. A new module `apps/server/src/vercel.ts` handles polling and caching. Results are stored on the existing `projects` table via a new `deployment_status` column (JSON string) and broadcast to clients through the existing WebSocket `projects` message type.

### Vercel API
- Endpoint: `GET https://api.vercel.com/v6/deployments?projectId={id}&limit=1&teamId={teamId}`
- Auth: Bearer token via `VERCEL_API_TOKEN` environment variable
- Response includes: `state` (BUILDING, READY, ERROR, QUEUED, CANCELED), `url`, `meta.githubCommitMessage`, `created`
- Rate limit: 100 requests per 60 seconds per token

### Configuration
Vercel project IDs are mapped to DevPulse project names via environment variable:
```
VERCEL_API_TOKEN=vercel_xxxxx
VERCEL_PROJECTS={"MyApp":"prj_abc123","OtherProject":"prj_def456"}
```
This avoids database schema for configuration while keeping it simple.

### Data Flow
1. Server polls Vercel API every 30s for each configured project
2. Results cached in-memory and written to `projects.deployment_status` column
3. Existing `broadcastProjects()` in index.ts already sends project data over WebSocket
4. Client reads `deployment_status` from the project object in ProjectOverview.vue

## Tasks
- [ ] Task 1: Add `deployment_status` TEXT column to `projects` table in `apps/server/src/enricher.ts` `initEnricher()` function (migration-safe with ALTER TABLE IF NOT EXISTS pattern)
- [ ] Task 2: Add `deployment_status` field to `Project` interface in `apps/server/src/types.ts` as `deployment_status: string` (JSON string: `{state, url, commit_message, created, vercel_project_id}`)
- [ ] Task 3: Create `apps/server/src/vercel.ts` with:
  - `initVercelPoller(db: Database): void` - reads env vars, starts polling interval
  - `pollVercelDeployments(): Promise<void>` - fetches latest deployment for each configured project
  - `getDeploymentStatus(projectName: string): DeploymentStatus | null` - returns cached status
  - Type: `DeploymentStatus { state: string; url: string; commit_message: string; created: number; vercel_project_id: string }`
- [ ] Task 4: Call `initVercelPoller(getDb())` from `apps/server/src/index.ts` after `initEnricher()`
- [ ] Task 5: Update `ProjectOverview.vue` to display deployment status badge on project cards:
  - Read `deployment_status` from the project prop (parse JSON)
  - Show colored badge with state text and time-ago
  - Make badge clickable (opens `https://{deployment.url}` in new tab)
  - Hide section entirely if `deployment_status` is empty/null
- [ ] Task 6: Add `deployment_status` to the client-side `Project` type in `apps/client/src/types.ts`
- [ ] Task 7: Add `VERCEL_API_TOKEN` and `VERCEL_PROJECTS` to `.env.sample` with documentation comments

## Files to Create/Modify
| File | Action | Description |
|------|--------|-------------|
| `apps/server/src/vercel.ts` | Create | Vercel API polling module with caching |
| `apps/server/src/types.ts` | Modify | Add `deployment_status: string` to `Project` interface |
| `apps/server/src/enricher.ts` | Modify | Add `deployment_status` column to projects table in `initEnricher()` |
| `apps/server/src/index.ts` | Modify | Import and call `initVercelPoller(getDb())` |
| `apps/client/src/types.ts` | Modify | Add `deployment_status` field to client Project type (if separate) |
| `apps/client/src/components/ProjectOverview.vue` | Modify | Add deployment status badge to project cards |
| `.env.sample` | Modify | Add `VERCEL_API_TOKEN` and `VERCEL_PROJECTS` entries |

## Testing
- [ ] Test 1: Unit test `vercel.ts` - mock fetch to Vercel API, verify correct parsing of READY/BUILDING/ERROR states
- [ ] Test 2: Unit test `vercel.ts` - verify graceful behavior when `VERCEL_API_TOKEN` is not set (no errors, no polling)
- [ ] Test 3: Unit test `vercel.ts` - verify graceful behavior when Vercel API returns 401/403/429
- [ ] Test 4: Integration test - POST an event for a project with Vercel configured, verify `deployment_status` appears in `GET /api/projects` response
- [ ] Test 5: Visual test - verify deployment badge renders correctly in all states (ready/building/error/queued/hidden)

## Definition of Done
- [ ] Code compiles without errors
- [ ] All acceptance criteria met
- [ ] No TypeScript errors
- [ ] Responsive on mobile and desktop
- [ ] Dark/light theme support works (badge uses CSS variables)
- [ ] Deployment polling does not start if env vars are missing
- [ ] No API token leaks to the client (token stays server-side only)
