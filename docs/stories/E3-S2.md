# E3-S2: Story/Task Layer - Branch-to-Task Mapping

## Story
**As a** developer managing multiple feature branches across projects
**I want** DevPulse to automatically parse my branch names into human-readable task names
**So that** I can see what each agent is working on at a glance without memorising branch conventions

## Status
- **Epic**: Extended Features
- **Priority**: P2-Medium
- **Points**: 5
- **Sprint**: 5
- **Dependencies**: None (Session and Project types already exist)

## Acceptance Criteria
- [ ] AC1: Branch names following common conventions are automatically parsed into task context displayed on project cards. Examples:
  - `feature/AUTH-123-login-flow` -> "AUTH-123: Login Flow"
  - `fix/broken-navbar` -> "Fix: Broken Navbar"
  - `chore/update-deps` -> "Chore: Update Deps"
  - `hotfix/critical-bug` -> "Hotfix: Critical Bug"
  - `release/v2.1.0` -> "Release: v2.1.0"
- [ ] AC2: The parsed task context appears on the Session row inside project cards in ProjectOverview.vue, replacing or augmenting the raw branch name display
- [ ] AC3: Branch names that don't match any known pattern display the branch name as-is (graceful fallback)
- [ ] AC4: The task_context field is stored on the Session record and updates when the branch changes
- [ ] AC5: The parser handles edge cases: no ticket number, multiple hyphens, nested slashes (e.g., `feature/team/AUTH-456-thing`)

## Technical Notes

### Branch Parsing Logic
Create a pure function `parseBranchToTask(branch: string): TaskContext` that handles:

```typescript
interface TaskContext {
  prefix: string;       // "feature" | "fix" | "chore" | "hotfix" | "release" | ""
  ticket_id: string;    // "AUTH-123" or ""
  description: string;  // "Login Flow" (title-cased from hyphen-separated)
  display: string;      // "AUTH-123: Login Flow" or "Fix: Broken Navbar"
}
```

Parsing rules (in order):
1. Split on first `/` to get prefix and remainder
2. Supported prefixes: `feature`, `fix`, `bugfix`, `chore`, `hotfix`, `release`, `refactor`, `docs`, `test`
3. From remainder, extract ticket ID: match `[A-Z]+-\d+` pattern
4. Convert remaining hyphen-separated words to Title Case for description
5. Build display string: `"{ticket_id}: {description}"` or `"{Prefix}: {description}"`

### Data Flow
1. In `enricher.ts`, when `extractBranch()` returns a branch name, also call `parseBranchToTask(branch)`
2. Store the `task_context` (JSON string of `TaskContext`) on the session record
3. The existing `broadcastProjects()` already sends session data over WebSocket
4. Client reads `task_context` from the session object in ProjectOverview.vue

### No External API Integration in This Story
The optional Linear/GitHub Issues/Notion integration is future scope. This story focuses purely on branch name parsing. A future story could enrich `TaskContext` with data from external APIs by matching `ticket_id`.

## Tasks
- [ ] Task 1: Create `apps/server/src/branch-parser.ts` with:
  - `parseBranchToTask(branch: string): TaskContext` pure function
  - `TaskContext` interface (prefix, ticket_id, description, display)
  - Handle all supported prefixes and edge cases
- [ ] Task 2: Add `task_context` TEXT column to `sessions` table in `apps/server/src/enricher.ts` `initEnricher()` (migration-safe ALTER TABLE)
- [ ] Task 3: Add `task_context: string` field to `Session` interface in `apps/server/src/types.ts`
- [ ] Task 4: Update `upsertSession()` in `enricher.ts` to call `parseBranchToTask()` when branch is available and store result as JSON in `task_context`
- [ ] Task 5: Update `ProjectOverview.vue` session rows to display parsed task context:
  - Parse `session.task_context` JSON
  - Show `display` text with prefix-appropriate styling (e.g., green for feature, orange for fix, blue for chore)
  - Fall back to raw branch name if task_context is empty
- [ ] Task 6: Add `task_context` to client-side `Session` type in `apps/client/src/types.ts`

## Files to Create/Modify
| File | Action | Description |
|------|--------|-------------|
| `apps/server/src/branch-parser.ts` | Create | Branch name parsing logic with `parseBranchToTask()` |
| `apps/server/src/types.ts` | Modify | Add `task_context: string` to `Session` interface |
| `apps/server/src/enricher.ts` | Modify | Add `task_context` column to sessions table, call parser in `upsertSession()` |
| `apps/client/src/types.ts` | Modify | Add `task_context` field to client Session type |
| `apps/client/src/components/ProjectOverview.vue` | Modify | Display parsed task context on session rows |

## Testing
- [ ] Test 1: Unit test `branch-parser.ts` - `feature/AUTH-123-login-flow` -> `{prefix: "feature", ticket_id: "AUTH-123", description: "Login Flow", display: "AUTH-123: Login Flow"}`
- [ ] Test 2: Unit test `branch-parser.ts` - `fix/broken-navbar` -> `{prefix: "fix", ticket_id: "", description: "Broken Navbar", display: "Fix: Broken Navbar"}`
- [ ] Test 3: Unit test `branch-parser.ts` - `main` -> `{prefix: "", ticket_id: "", description: "main", display: "main"}` (no prefix, passthrough)
- [ ] Test 4: Unit test `branch-parser.ts` - `feature/team/AUTH-456-multi-level` -> handles nested slashes
- [ ] Test 5: Unit test `branch-parser.ts` - `release/v2.1.0` -> `{prefix: "release", ticket_id: "", description: "v2.1.0", display: "Release: v2.1.0"}`
- [ ] Test 6: Integration test - POST SessionStart event with branch `feature/PROJ-42-new-feature`, verify session record has populated `task_context`

## Definition of Done
- [ ] Code compiles without errors
- [ ] All acceptance criteria met
- [ ] No TypeScript errors
- [ ] Responsive on mobile and desktop
- [ ] Dark/light theme support works (prefix badges use CSS variables)
- [ ] Branch parser has 100% test coverage for all supported prefixes
- [ ] Graceful fallback for unparseable branch names
