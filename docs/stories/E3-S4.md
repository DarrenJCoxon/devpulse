# E3-S4: Desktop Notification System

## Story
**As a** developer who runs AI agents in the background while doing other work
**I want** to receive desktop notifications when an agent needs my attention
**So that** I don't miss important prompts, permission requests, or completion events

## Status
- **Epic**: Extended Features
- **Priority**: P1-High
- **Points**: 3
- **Sprint**: 5
- **Dependencies**: None (Notification hook events already flow through the system)

## Acceptance Criteria
- [ ] AC1: When an agent enters a "waiting" state (Notification hook event), a desktop notification appears with the agent name, project, and the notification message
- [ ] AC2: Notifications use the browser's Web Notifications API (works cross-platform in Chrome/Firefox/Safari)
- [ ] AC3: A notification settings panel allows the user to configure which event types trigger notifications: Notification (waiting), Stop (session ended), PostToolUseFailure (tool error)
- [ ] AC4: The notification settings are persisted in localStorage so they survive page refreshes
- [ ] AC5: Clicking a desktop notification focuses the DevPulse browser tab
- [ ] AC6: The user is prompted for notification permissions on first use, with a clear explanation of why
- [ ] AC7: When notifications are not permitted or not supported, the settings panel shows an informative message
- [ ] AC8: Notifications include the project name, agent identifier (source_app:session_id truncated to 8 chars), and a brief message

## Technical Notes

### Web Notifications API
Use the standard `Notification` API available in all modern browsers:
```typescript
if ('Notification' in window && Notification.permission === 'granted') {
  new Notification('DevPulse: Agent Waiting', {
    body: 'MyProject - claude:a1b2c3d4 needs input',
    icon: '/favicon.ico',
    tag: `devpulse-${sessionId}` // Prevents duplicate notifications
  });
}
```

### Architecture
- Notification logic lives in a new composable: `apps/client/src/composables/useNotifications.ts`
- The composable watches the WebSocket event stream (already available via `useWebSocket`)
- Settings are stored in localStorage under key `devpulse-notification-settings`
- The settings UI is a small panel/modal accessible from the header

### Event Filtering
The composable receives each new event from the WebSocket stream and checks:
1. Is the event type in the user's enabled notification types?
2. Is the browser tab currently hidden (no point notifying if user is already looking)?
3. Has a notification with the same `tag` already been shown recently?

### Notification Content by Event Type
- **Notification** (waiting): "{project} - {agent_id} is waiting for input"
- **Stop** (session ended): "{project} - {agent_id} session completed"
- **PostToolUseFailure** (error): "{project} - {agent_id} tool failure: {tool_name}"

### No Server-Side Component
This feature is entirely client-side. The macOS `osascript`/`terminal-notifier` approach mentioned in the brief is unnecessary since the Web Notifications API provides the same UX cross-platform without server dependencies.

## Tasks
- [ ] Task 1: Create `apps/client/src/composables/useNotifications.ts`:
  - `useNotifications(events: Ref<HookEvent[]>)` composable
  - `requestPermission(): Promise<NotificationPermission>` - wraps Notification.requestPermission
  - `sendNotification(title: string, body: string, tag: string): void` - sends if permitted and tab is hidden
  - `settings: Ref<NotificationSettings>` - reactive settings loaded from/saved to localStorage
  - Watch events array for new additions, filter by enabled types, send notification
  - `NotificationSettings { enabled: boolean; types: string[] }` (defaults: enabled=false, types=["Notification"])
- [ ] Task 2: Create `apps/client/src/components/NotificationSettings.vue`:
  - Toggle to enable/disable notifications (calls `requestPermission()` on enable)
  - Checkboxes for event types: Notification, Stop, PostToolUseFailure
  - Show permission status (granted/denied/default) with appropriate messaging
  - Small modal or dropdown panel, styled with Tailwind and CSS variables
- [ ] Task 3: Integrate into `apps/client/src/App.vue`:
  - Add notification bell button in the header (next to theme and filter buttons)
  - Import `useNotifications` composable, pass events ref
  - Import `NotificationSettings` component, toggle visibility on bell click
  - Show a subtle indicator dot on the bell when notifications are enabled
- [ ] Task 4: Add `NotificationSettings` type to `apps/client/src/types.ts`

## Files to Create/Modify
| File | Action | Description |
|------|--------|-------------|
| `apps/client/src/composables/useNotifications.ts` | Create | Notification composable with permission management and event watching |
| `apps/client/src/components/NotificationSettings.vue` | Create | Settings panel for notification preferences |
| `apps/client/src/App.vue` | Modify | Add notification bell button, integrate composable and settings panel |
| `apps/client/src/types.ts` | Modify | Add `NotificationSettings` interface |

## Testing
- [ ] Test 1: Unit test `useNotifications.ts` - when a Notification event is added to events array and notifications are enabled, `sendNotification` is called
- [ ] Test 2: Unit test `useNotifications.ts` - when event type is not in enabled types, no notification is sent
- [ ] Test 3: Unit test `useNotifications.ts` - when document is visible (tab focused), no notification is sent
- [ ] Test 4: Unit test `useNotifications.ts` - settings correctly save to and load from localStorage
- [ ] Test 5: Manual test - enable notifications, trigger a Notification event, verify desktop notification appears
- [ ] Test 6: Manual test - click notification, verify DevPulse tab receives focus

## Definition of Done
- [ ] Code compiles without errors
- [ ] All acceptance criteria met
- [ ] No TypeScript errors
- [ ] Responsive on mobile and desktop
- [ ] Dark/light theme support works
- [ ] Notification permission request only triggers on explicit user action (not on page load)
- [ ] Settings persist across page refreshes
- [ ] Graceful degradation when Notification API is not available
