# E4-S1: Agent Team Topology View

## Story
**As a** developer coordinating multi-agent teams across projects
**I want** a visual topology showing the hierarchy of team leads, builders, and validators with their real-time status
**So that** I can understand the agent team structure, see who is doing what, and quickly identify blocked or idle agents

## Status
- **Epic**: Multi-Agent Intelligence
- **Priority**: P1-High
- **Points**: 8
- **Sprint**: 7
- **Dependencies**: None (SubagentStart/SubagentStop events already captured in events table)

## Acceptance Criteria
- [ ] AC1: A new "Topology" tab/view shows a tree/graph visualization of agent relationships where parent agents (team leads) are connected to their subagents (builders, validators)
- [ ] AC2: The hierarchy is built from SubagentStart/SubagentStop events - the agent that spawned a subagent is the parent, the subagent is the child
- [ ] AC3: Each agent node shows: agent identifier (source_app:session_id truncated to 8 chars), current status (active/idle/waiting/stopped) with color-coded indicator, model name, and task assignment (from task_context if available)
- [ ] AC4: Agent nodes update in real-time as new events arrive over WebSocket (status changes, new subagents spawning, agents stopping)
- [ ] AC5: Clicking an agent node opens a detail panel showing: full session info, recent events for that agent, tool usage breakdown, and session duration
- [ ] AC6: The topology view can be filtered by project to show only agents working on a specific project
- [ ] AC7: Stopped agents are shown with reduced opacity but remain visible until the view is refreshed, preserving the team structure for review

## Technical Notes

### Data Model for Agent Hierarchy
SubagentStart events include `agent_id` in the payload. The spawning session is identified by `session_id` + `source_app`. Build the hierarchy by:

1. When a `SubagentStart` event arrives, record: `parent = {source_app, session_id}`, `child = {agent_id from payload}`
2. When a `SubagentStop` event arrives, mark the child agent as stopped

The server needs a new in-memory structure (or lightweight DB table) to track parent-child relationships:

```typescript
interface AgentNode {
  agent_id: string;       // source_app:session_id
  parent_id: string | null;  // null for root agents
  status: SessionStatus;
  model_name: string;
  project_name: string;
  task_context: string;
  started_at: number;
  last_event_at: number;
  children: string[];     // child agent_ids
}
```

### Server-Side: Agent Topology Tracking
Add topology tracking to the enricher:
- New table `agent_topology` with `agent_id, parent_id, session_id, source_app, project_name, status`
- On SubagentStart: insert child record with parent reference
- On SubagentStop: update child status to stopped
- New query function: `getAgentTopology(projectName?: string): AgentNode[]`

### Client-Side: Tree Visualization
Use a simple CSS-based tree layout (flexbox/grid), not a heavy graph library. Each level of the tree is a row. Nodes are styled cards connected by CSS lines/borders.

```
[Team Lead: claude:a1b2c3d4]
    |--- [Builder: claude:e5f6g7h8]
    |--- [Validator: claude:i9j0k1l2]
              |--- [Sub-validator: claude:m3n4o5p6]
```

### API Endpoint
- `GET /api/topology?project=MyProject` returns the `AgentNode[]` tree
- Also broadcast topology updates via WebSocket as a new message type: `{ type: 'topology', data: AgentNode[] }`

### Detail Panel
When clicking a node, fetch that agent's events from the existing `GET /events/recent` endpoint filtered by session_id and source_app. Display in a slide-out panel or modal.

## Tasks
- [ ] Task 1: Create `agent_topology` table in `apps/server/src/enricher.ts` `initEnricher()`:
  ```sql
  CREATE TABLE IF NOT EXISTS agent_topology (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    agent_id TEXT NOT NULL,
    parent_id TEXT,
    session_id TEXT NOT NULL,
    source_app TEXT NOT NULL,
    project_name TEXT NOT NULL,
    status TEXT DEFAULT 'active',
    model_name TEXT DEFAULT '',
    started_at INTEGER NOT NULL,
    last_event_at INTEGER NOT NULL,
    UNIQUE(agent_id)
  )
  ```
- [ ] Task 2: Add `AgentNode` interface to `apps/server/src/types.ts`
- [ ] Task 3: Update `enrichEvent()` in `apps/server/src/enricher.ts` to handle SubagentStart/SubagentStop:
  - SubagentStart: extract `agent_id` from payload, insert into `agent_topology` with `parent_id = source_app:session_id`
  - SubagentStop: extract `agent_id` from payload, update status to 'stopped'
  - Update `last_event_at` for active topology nodes on any event from matching session
- [ ] Task 4: Add `getAgentTopology(projectName?: string): AgentNode[]` query function to `enricher.ts`:
  - Query `agent_topology` joined with `sessions` for status/model info
  - Build tree structure from flat records using parent_id references
  - Filter by project_name if provided
- [ ] Task 5: Add API route `GET /api/topology` to `apps/server/src/index.ts`:
  - Optional `?project=` query param
  - Returns `AgentNode[]` tree
- [ ] Task 6: Add topology to WebSocket broadcasts in `apps/server/src/index.ts`:
  - After enriching SubagentStart/SubagentStop events, broadcast `{ type: 'topology', data: getAgentTopology() }`
  - Send initial topology on WebSocket connection open
- [ ] Task 7: Create `apps/client/src/components/AgentTopology.vue`:
  - Tree visualization using CSS flexbox (no external graph library)
  - Each node: card with agent_id, status dot, model name, task context
  - Color-coded status indicators matching ProjectOverview.vue convention (green=active, yellow=waiting, gray=idle, red=stopped)
  - Stopped nodes shown at 50% opacity
  - Project filter dropdown at top
  - Click handler on nodes to open detail panel
- [ ] Task 8: Create `apps/client/src/components/AgentDetailPanel.vue`:
  - Slide-out panel showing full agent details
  - Fetches recent events for the selected agent from `/events/recent` filtered by session_id
  - Shows: session info, event timeline (last 20 events), tool breakdown, duration
  - Close button
- [ ] Task 9: Add `AgentNode` type to `apps/client/src/types.ts` and extend `WebSocketMessage` type to include `'topology'`
- [ ] Task 10: Integrate `AgentTopology.vue` into `apps/client/src/App.vue`:
  - Add "Topology" toggle button in header
  - Conditionally render the topology view
  - Pass WebSocket data (or let component self-fetch)
- [ ] Task 11: Update `useWebSocket.ts` to handle `'topology'` message type and expose `topology` ref

## Files to Create/Modify
| File | Action | Description |
|------|--------|-------------|
| `apps/server/src/enricher.ts` | Modify | Add `agent_topology` table, SubagentStart/Stop handling, `getAgentTopology()` |
| `apps/server/src/types.ts` | Modify | Add `AgentNode` interface |
| `apps/server/src/index.ts` | Modify | Add `GET /api/topology` route, broadcast topology on WebSocket |
| `apps/client/src/components/AgentTopology.vue` | Create | Tree visualization component |
| `apps/client/src/components/AgentDetailPanel.vue` | Create | Agent detail slide-out panel |
| `apps/client/src/types.ts` | Modify | Add `AgentNode` type, extend `WebSocketMessage` |
| `apps/client/src/composables/useWebSocket.ts` | Modify | Handle `'topology'` message type |
| `apps/client/src/App.vue` | Modify | Add Topology toggle and render component |

## Testing
- [ ] Test 1: Unit test enricher - SubagentStart event creates topology record with correct parent_id
- [ ] Test 2: Unit test enricher - SubagentStop event updates topology record status to 'stopped'
- [ ] Test 3: Unit test enricher - `getAgentTopology()` builds correct tree from flat records (parent with 2 children)
- [ ] Test 4: Unit test enricher - `getAgentTopology('MyProject')` filters by project correctly
- [ ] Test 5: Integration test - POST SubagentStart event, GET /api/topology, verify tree structure
- [ ] Test 6: Visual test - verify tree renders correctly with 3 levels of nesting
- [ ] Test 7: Visual test - verify stopped nodes appear with reduced opacity

## Definition of Done
- [ ] Code compiles without errors
- [ ] All acceptance criteria met
- [ ] No TypeScript errors
- [ ] Responsive on mobile and desktop (tree collapses to vertical layout on mobile)
- [ ] Dark/light theme support works
- [ ] Tree updates in real-time without full page refresh
- [ ] Detail panel loads agent events correctly
- [ ] No external graph library dependencies (pure CSS tree)
