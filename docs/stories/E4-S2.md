# E4-S2: Token/Cost Tracking Dashboard

## Story
**As a** developer paying for AI API usage across multiple projects and sessions
**I want** to see estimated token costs per project, per session, and per day
**So that** I can understand my AI spend, identify costly sessions, and optimise my workflow to control expenses

## Status
- **Epic**: Multi-Agent Intelligence
- **Priority**: P1-High
- **Points**: 8
- **Sprint**: 7
- **Dependencies**: None (model_name already tracked on events and sessions)

## Acceptance Criteria
- [ ] AC1: A new "Costs" tab/view shows estimated API costs broken down by project, session, and time period
- [ ] AC2: Cost estimates are calculated from event counts per session combined with the model_name to determine per-token pricing
- [ ] AC3: The dashboard shows three views: per-project totals, per-session detail, and a daily cost chart
- [ ] AC4: Model pricing is configurable but ships with sensible defaults: Opus 4.6 ($15/$75 per 1M input/output tokens), Sonnet 4.5 ($3/$15), Haiku 4.5 ($0.80/$4)
- [ ] AC5: Each session's cost estimate includes: estimated input tokens (from event payloads), estimated output tokens (from tool results), model used, and calculated cost
- [ ] AC6: The daily chart shows cost trend over the last 7/14/30 days with a line per project
- [ ] AC7: Cost data persists in the database so historical trends are available across server restarts

## Technical Notes

### Token Estimation Strategy
Since actual token counts are not available from hook events, estimate based on event payload sizes:
- **Input tokens**: Approximate from `JSON.stringify(event.payload).length / 4` (rough chars-to-tokens ratio)
- **Output tokens**: Approximate from tool result sizes in PostToolUse events
- **Per-event overhead**: Add ~500 tokens per event for system prompt/context overhead
- These are rough estimates but provide directional insight. Display with a "~" prefix and an "estimated" label.

### Pricing Table
```typescript
interface ModelPricing {
  model_pattern: string;   // Regex pattern to match model_name
  input_per_1m: number;    // USD per 1M input tokens
  output_per_1m: number;   // USD per 1M output tokens
  display_name: string;
}

const DEFAULT_PRICING: ModelPricing[] = [
  { model_pattern: 'opus', input_per_1m: 15, output_per_1m: 75, display_name: 'Opus 4.6' },
  { model_pattern: 'sonnet', input_per_1m: 3, output_per_1m: 15, display_name: 'Sonnet 4.5' },
  { model_pattern: 'haiku', input_per_1m: 0.80, output_per_1m: 4, display_name: 'Haiku 4.5' },
];
```
Match `model_name` from the session/event against these patterns (case-insensitive). Fall back to Sonnet pricing if unknown.

### Database: cost_estimates Table
```sql
CREATE TABLE IF NOT EXISTS cost_estimates (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  session_id TEXT NOT NULL,
  source_app TEXT NOT NULL,
  project_name TEXT NOT NULL,
  model_name TEXT NOT NULL,
  estimated_input_tokens INTEGER DEFAULT 0,
  estimated_output_tokens INTEGER DEFAULT 0,
  estimated_cost_usd REAL DEFAULT 0,
  event_count INTEGER DEFAULT 0,
  calculated_at INTEGER NOT NULL,
  UNIQUE(session_id, source_app)
)
```

### Cost Calculation Flow
1. On every event, update running token estimates for the session in `cost_estimates`
2. Recalculate `estimated_cost_usd` based on accumulated tokens and model pricing
3. The API endpoint aggregates cost_estimates by project/date for dashboard views

### API Endpoints
- `GET /api/costs?group=project` - cost totals per project (all time or with date range)
- `GET /api/costs?group=session&project=MyProject` - per-session costs for a project
- `GET /api/costs?group=daily&days=7` - daily cost totals for chart

## Tasks
- [ ] Task 1: Add `ModelPricing` interface and `DEFAULT_PRICING` constant to `apps/server/src/types.ts`
- [ ] Task 2: Create `cost_estimates` table in `apps/server/src/enricher.ts` `initEnricher()`:
  - Schema as defined above
  - Index on `project_name` and `calculated_at`
- [ ] Task 3: Create `apps/server/src/costs.ts` with:
  - `estimateTokensFromEvent(event: HookEvent): { input: number; output: number }` - estimate token counts from payload size
  - `updateCostEstimate(sessionId: string, sourceApp: string, projectName: string, modelName: string, inputTokens: number, outputTokens: number): void` - upsert into cost_estimates
  - `getCostsByProject(startDate?: number, endDate?: number): ProjectCost[]` - aggregate by project
  - `getCostsBySession(projectName: string): SessionCost[]` - per-session for a project
  - `getDailyCosts(days: number): DailyCost[]` - daily aggregates for chart
  - `matchModelPricing(modelName: string): ModelPricing` - match model to pricing tier
- [ ] Task 4: Call `updateCostEstimate()` from `enrichEvent()` in `apps/server/src/enricher.ts` for every event
- [ ] Task 5: Add API routes to `apps/server/src/index.ts`:
  - `GET /api/costs?group=project`
  - `GET /api/costs?group=session&project=X`
  - `GET /api/costs?group=daily&days=N`
- [ ] Task 6: Create `apps/client/src/components/CostDashboard.vue`:
  - Three-panel layout: project totals (cards), session breakdown (table), daily trend (chart)
  - Project cards show: project name, total estimated cost, model distribution, session count
  - Session table: session_id (truncated), model, duration, estimated tokens, estimated cost
  - Daily trend: simple bar chart (reuse chart patterns from LivePulseChart.vue) showing cost per day
  - All cost values prefixed with "~" and labeled "estimated"
  - Time range selector for daily chart (7/14/30 days)
- [ ] Task 7: Add cost-related types to `apps/client/src/types.ts`: `ProjectCost`, `SessionCost`, `DailyCost`
- [ ] Task 8: Integrate `CostDashboard.vue` into `apps/client/src/App.vue`:
  - Add "Costs" toggle button in header
  - Conditionally render the cost dashboard

## Files to Create/Modify
| File | Action | Description |
|------|--------|-------------|
| `apps/server/src/costs.ts` | Create | Cost estimation, tracking, and aggregation logic |
| `apps/server/src/types.ts` | Modify | Add `ModelPricing`, `ProjectCost`, `SessionCost`, `DailyCost` interfaces |
| `apps/server/src/enricher.ts` | Modify | Add `cost_estimates` table, call cost tracking on events |
| `apps/server/src/index.ts` | Modify | Add `GET /api/costs` routes |
| `apps/client/src/components/CostDashboard.vue` | Create | Cost dashboard with project/session/daily views |
| `apps/client/src/types.ts` | Modify | Add client-side cost types |
| `apps/client/src/App.vue` | Modify | Add Costs toggle and render component |

## Testing
- [ ] Test 1: Unit test `costs.ts` - `estimateTokensFromEvent()` returns reasonable estimates for a typical PostToolUse event (~500-2000 tokens)
- [ ] Test 2: Unit test `costs.ts` - `matchModelPricing()` correctly matches "claude-opus-4-6" to Opus pricing
- [ ] Test 3: Unit test `costs.ts` - `matchModelPricing()` correctly matches "claude-sonnet-4-5-20250929" to Sonnet pricing
- [ ] Test 4: Unit test `costs.ts` - `matchModelPricing()` returns Sonnet as default for unknown model names
- [ ] Test 5: Unit test `costs.ts` - `getCostsByProject()` correctly aggregates costs across sessions
- [ ] Test 6: Integration test - POST 10 events for a session, GET /api/costs?group=project, verify accumulated estimate
- [ ] Test 7: Integration test - GET /api/costs?group=daily&days=7 returns 7 entries

## Definition of Done
- [ ] Code compiles without errors
- [ ] All acceptance criteria met
- [ ] No TypeScript errors
- [ ] Responsive on mobile and desktop
- [ ] Dark/light theme support works
- [ ] All cost values clearly labeled as estimates
- [ ] Cost calculation is performant (no expensive queries on every event)
- [ ] Historical cost data persists across server restarts
