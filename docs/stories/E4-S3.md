# E4-S3: Context Window Health Monitor

## Story
**As a** developer running long AI coding sessions
**I want** to see how frequently each agent's context window is being compacted
**So that** I can identify sessions that are running inefficiently and may benefit from being restarted or restructured

## Status
- **Epic**: Multi-Agent Intelligence
- **Priority**: P2-Medium
- **Points**: 5
- **Sprint**: 8
- **Dependencies**: None (PreCompact events already flow through the system)

## Acceptance Criteria
- [ ] AC1: Each active session in the project cards (ProjectOverview.vue) shows a context health indicator based on PreCompact event frequency
- [ ] AC2: The indicator uses a simple traffic light system: green (no compactions in last 10 minutes), yellow (1-2 compactions in last 10 minutes), red (3+ compactions in last 10 minutes)
- [ ] AC3: Hovering over the indicator shows a tooltip with: total compaction count for the session, time since last compaction, compaction frequency (compactions per hour)
- [ ] AC4: A dedicated Context Health section can be expanded in the ProjectOverview to show compaction history as a mini timeline for each session
- [ ] AC5: When a session's compaction frequency exceeds the red threshold, it is highlighted prominently as a potential efficiency concern
- [ ] AC6: Compaction tracking data updates in real-time as new PreCompact events arrive

## Technical Notes

### PreCompact Event
The `PreCompact` hook event fires when Claude Code is about to compress the conversation context. This is a strong signal that the context window is full. Frequent compactions mean the agent is working on large tasks that keep filling context.

### Data Tracking
Track compaction events per session in a lightweight structure. Two options:

**Option A (recommended): Enhance existing sessions table**
Add `compaction_count INTEGER DEFAULT 0` and `last_compaction_at INTEGER` columns to the sessions table. Also store recent compaction timestamps in a JSON array column `compaction_history TEXT DEFAULT '[]'` (keep last 20 timestamps for the mini timeline).

This avoids a new table and keeps the data co-located with session info.

### Compaction Frequency Calculation
```typescript
function getCompactionHealth(session: Session): 'green' | 'yellow' | 'red' {
  const tenMinutesAgo = Date.now() - 600000;
  const recentCompactions = session.compaction_history
    .filter(ts => ts > tenMinutesAgo).length;

  if (recentCompactions >= 3) return 'red';
  if (recentCompactions >= 1) return 'yellow';
  return 'green';
}
```

### Server-Side Changes
In `enrichEvent()`, when `hook_event_type === 'PreCompact'`:
1. Increment `compaction_count` on the session
2. Set `last_compaction_at` to now
3. Append timestamp to `compaction_history` (keep last 20)
4. The existing `broadcastProjects()` sends updated session data to clients

### Client-Side Changes
Enhance the session rows in `ProjectOverview.vue` to show the health indicator. The indicator is a small colored dot with a tooltip, positioned next to the session identifier.

## Tasks
- [ ] Task 1: Add columns to `sessions` table in `apps/server/src/enricher.ts` `initEnricher()` (migration-safe ALTER TABLE):
  - `compaction_count INTEGER DEFAULT 0`
  - `last_compaction_at INTEGER`
  - `compaction_history TEXT DEFAULT '[]'`
- [ ] Task 2: Add `compaction_count`, `last_compaction_at`, and `compaction_history` fields to `Session` interface in `apps/server/src/types.ts`
- [ ] Task 3: Update `enrichEvent()` in `apps/server/src/enricher.ts` to handle `PreCompact` events:
  - Increment `compaction_count`
  - Set `last_compaction_at` to current timestamp
  - Append timestamp to `compaction_history` JSON array (trim to last 20 entries)
- [ ] Task 4: Update `ProjectOverview.vue` session rows:
  - Add context health indicator dot next to session identifier
  - Calculate health status from `compaction_history` (green/yellow/red)
  - Add tooltip on hover showing compaction count, last compaction time, and frequency
  - Highlight red sessions with a subtle background color or border
- [ ] Task 5: Add `compaction_count`, `last_compaction_at`, `compaction_history` to client-side `Session` type in `apps/client/src/types.ts`

## Files to Create/Modify
| File | Action | Description |
|------|--------|-------------|
| `apps/server/src/enricher.ts` | Modify | Add compaction columns to sessions table, handle PreCompact in enrichEvent() |
| `apps/server/src/types.ts` | Modify | Add compaction fields to Session interface |
| `apps/client/src/types.ts` | Modify | Add compaction fields to client Session type |
| `apps/client/src/components/ProjectOverview.vue` | Modify | Add context health indicator to session rows |

## Testing
- [ ] Test 1: Unit test enricher - PreCompact event increments `compaction_count` from 0 to 1
- [ ] Test 2: Unit test enricher - PreCompact event appends timestamp to `compaction_history` array
- [ ] Test 3: Unit test enricher - `compaction_history` is trimmed to last 20 entries when it exceeds 20
- [ ] Test 4: Unit test client - health calculation returns 'green' when compaction_history has no recent entries
- [ ] Test 5: Unit test client - health calculation returns 'red' when 3+ compactions in last 10 minutes
- [ ] Test 6: Integration test - POST 3 PreCompact events for same session within 10 minutes, verify session shows red health status in GET /api/sessions response

## Definition of Done
- [ ] Code compiles without errors
- [ ] All acceptance criteria met
- [ ] No TypeScript errors
- [ ] Responsive on mobile and desktop
- [ ] Dark/light theme support works (health indicator colors work in both themes)
- [ ] Tooltip is readable in both light and dark themes
- [ ] PreCompact handling does not impact event processing performance
- [ ] Graceful display when no PreCompact events have occurred (green status, no tooltip content about "last compaction")
