# E4-S4: Agent Performance Metrics

## Story
**As a** developer optimising my AI-assisted development workflow
**I want** to see performance metrics for each agent session including tool success rates, turn completion times, and activity patterns
**So that** I can identify inefficient sessions, compare agent performance across projects, and tune my workflow for maximum productivity

## Status
- **Epic**: Multi-Agent Intelligence
- **Priority**: P2-Medium
- **Points**: 8
- **Sprint**: 8
- **Dependencies**: None (all required event types already captured)

## Acceptance Criteria
- [ ] AC1: A new "Metrics" tab/view shows agent performance data with per-session and per-project breakdowns
- [ ] AC2: Tool success rate is calculated as `PostToolUse / (PostToolUse + PostToolUseFailure)` per session and displayed as a percentage with a visual bar
- [ ] AC3: Turn completion time is measured as the duration between a `UserPromptSubmit` event and the next `Stop` or `Notification` event for the same session, displayed as average and median
- [ ] AC4: Activity rate is shown as events per minute for each session, with a sparkline or mini chart showing activity over time
- [ ] AC5: A per-project comparison table shows: average tool success rate, average turn time, total event count, and total session duration across all sessions for that project
- [ ] AC6: Metrics data can be filtered by project and date range
- [ ] AC7: The metrics view highlights outliers: sessions with notably low tool success rates (<80%) or high turn completion times

## Technical Notes

### Metrics Computation
All metrics are computed on-demand from the events table. No new database table is needed since event volume per session is manageable (typically hundreds, not thousands).

```typescript
interface SessionMetrics {
  session_id: string;
  source_app: string;
  project_name: string;
  model_name: string;
  // Tool metrics
  tool_use_count: number;
  tool_failure_count: number;
  tool_success_rate: number;       // 0-100 percentage
  tool_breakdown: Record<string, { success: number; failure: number }>;
  // Turn metrics
  turn_count: number;
  avg_turn_duration_seconds: number;
  median_turn_duration_seconds: number;
  min_turn_duration_seconds: number;
  max_turn_duration_seconds: number;
  // Activity metrics
  total_events: number;
  events_per_minute: number;
  session_duration_minutes: number;
  // Timeline (for sparkline)
  activity_timeline: Array<{ minute: number; events: number }>;
}

interface ProjectMetrics {
  project_name: string;
  session_count: number;
  avg_tool_success_rate: number;
  avg_turn_duration_seconds: number;
  total_events: number;
  total_duration_minutes: number;
}
```

### Turn Duration Calculation
A "turn" starts at `UserPromptSubmit` and ends at the next `Stop` or `Notification` (whichever comes first) for the same session. Steps:
1. Query events for a session, ordered by timestamp
2. Walk through events, pairing UserPromptSubmit with the next Stop/Notification
3. Calculate duration of each pair
4. Compute avg, median, min, max

### Activity Timeline
For the sparkline, bucket events by minute within the session duration. Each bucket has a count of events. This creates a simple time series suitable for a small inline chart.

### API Endpoints
- `GET /api/metrics?group=session&project=X` - per-session metrics for a project
- `GET /api/metrics?group=project` - per-project aggregate metrics
- Optional date filter: `&start=timestamp&end=timestamp`

### Client Visualisation
- Tool success rate: horizontal bar (green fill for success percentage)
- Turn time: numeric display with color coding (green <30s, yellow 30-120s, red >120s)
- Activity sparkline: tiny bar chart inline in the table row (use SVG, no external library)
- Outlier highlighting: yellow background for sessions with success rate <80% or turn time >120s

## Tasks
- [ ] Task 1: Create `apps/server/src/metrics.ts` with:
  - `getSessionMetrics(sessionId: string, sourceApp: string): SessionMetrics` - compute all metrics from events table
  - `getProjectMetrics(projectName?: string): ProjectMetrics[]` - aggregate across sessions per project
  - `calculateTurnDurations(events: HookEvent[]): number[]` - extract turn durations from event sequence
  - `buildActivityTimeline(events: HookEvent[], startedAt: number): Array<{minute: number; events: number}>` - bucket events by minute
  - Helper: `calculateMedian(values: number[]): number`
- [ ] Task 2: Add `SessionMetrics` and `ProjectMetrics` interfaces to `apps/server/src/types.ts`
- [ ] Task 3: Add API routes to `apps/server/src/index.ts`:
  - `GET /api/metrics?group=session&project=X` -> calls `getSessionMetrics()` for each session in project
  - `GET /api/metrics?group=project` -> calls `getProjectMetrics()`
- [ ] Task 4: Create `apps/client/src/components/AgentMetrics.vue`:
  - Toggle between project view and session view
  - Project view: table with project name, session count, avg success rate (bar), avg turn time, total events, total duration
  - Session view (per project): table with session_id, model, success rate (bar), avg turn time, events/min, duration, activity sparkline
  - Outlier highlighting: yellow row background for low success rate or high turn time
  - Date range filter and project filter
  - SVG sparkline component for activity timeline (inline, ~60px wide)
- [ ] Task 5: Add `SessionMetrics` and `ProjectMetrics` types to `apps/client/src/types.ts`
- [ ] Task 6: Integrate `AgentMetrics.vue` into `apps/client/src/App.vue`:
  - Add "Metrics" toggle button in header
  - Conditionally render the metrics view

## Files to Create/Modify
| File | Action | Description |
|------|--------|-------------|
| `apps/server/src/metrics.ts` | Create | Metrics computation from events data |
| `apps/server/src/types.ts` | Modify | Add `SessionMetrics`, `ProjectMetrics` interfaces |
| `apps/server/src/index.ts` | Modify | Add `GET /api/metrics` routes |
| `apps/client/src/components/AgentMetrics.vue` | Create | Metrics dashboard with tables, bars, and sparklines |
| `apps/client/src/types.ts` | Modify | Add client-side metrics types |
| `apps/client/src/App.vue` | Modify | Add Metrics toggle and render component |

## Testing
- [ ] Test 1: Unit test `metrics.ts` - `calculateTurnDurations()` correctly pairs UserPromptSubmit with Stop events and calculates durations
- [ ] Test 2: Unit test `metrics.ts` - `calculateTurnDurations()` handles edge case where session ends without Stop (ignores incomplete turns)
- [ ] Test 3: Unit test `metrics.ts` - tool success rate calculation: 8 PostToolUse + 2 PostToolUseFailure = 80%
- [ ] Test 4: Unit test `metrics.ts` - `buildActivityTimeline()` correctly buckets 10 events across 3 minutes
- [ ] Test 5: Unit test `metrics.ts` - `calculateMedian()` returns correct median for odd and even length arrays
- [ ] Test 6: Integration test - seed events for a session, GET /api/metrics?group=session, verify computed metrics match expected values
- [ ] Test 7: Visual test - verify success rate bars, sparklines, and outlier highlighting render correctly

## Definition of Done
- [ ] Code compiles without errors
- [ ] All acceptance criteria met
- [ ] No TypeScript errors
- [ ] Responsive on mobile and desktop (tables scroll horizontally on mobile)
- [ ] Dark/light theme support works
- [ ] Metrics computation completes in <500ms for sessions with up to 1000 events
- [ ] Sparklines render correctly at small sizes
- [ ] Outlier thresholds are clearly documented in the code
