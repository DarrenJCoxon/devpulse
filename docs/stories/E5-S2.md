# E5-S2: Session Replay

## Story
**As a** developer reviewing past Claude Code sessions
**I want** to replay a session's timeline showing every tool call, file edit, and bash command in chronological order
**So that** I can understand exactly what the agent did, which files were touched, and how the work progressed

## Status
- **Epic**: Developer Experience & Productivity
- **Priority**: P1-High
- **Points**: 8
- **Sprint**: 5
- **Dependencies**: E1-S1 (DevLogTimeline must exist to click into replay)

## Acceptance Criteria
- [ ] AC1: Clicking a dev log entry in DevLogTimeline opens a SessionReplay view showing all events for that session in chronological order
- [ ] AC2: Each event in the replay timeline displays: timestamp, event type with icon, tool name (if tool event), and a summary of what happened
- [ ] AC3: File operations (Read, Write, Edit) are visually distinguished with color coding -- Read shows blue (info), Write shows green (created/overwrite), Edit shows amber (modified)
- [ ] AC4: Bash commands display the command text in a monospace code block, truncated to 200 characters with "show more" expansion
- [ ] AC5: A session stats header shows: total duration, total events, files read vs written vs edited counts, and a tool usage breakdown bar chart
- [ ] AC6: Each event row is collapsible -- clicking expands to show full payload details (tool_input, tool_result snippets)
- [ ] AC7: A "Back to Dev Logs" button returns to the DevLogTimeline view
- [ ] AC8: Events are fetched from a new server endpoint that returns all events for a specific session_id and source_app combination

## Technical Notes

### Architecture
- New component `SessionReplay.vue` receives `sessionId` and `sourceApp` as props
- Fetches events from new endpoint: `GET /api/sessions/:sessionId/events?source_app=:sourceApp`
- The parent component (App.vue or a future tab/router) toggles between DevLogTimeline and SessionReplay views using a reactive state variable

### New Server Endpoint
Add to `apps/server/src/index.ts`:
```typescript
// GET /api/sessions/:sessionId/events?source_app=sourceApp
// Returns all events for a session, ordered by timestamp ASC
```

Query in `apps/server/src/db.ts`:
```typescript
export function getEventsForSession(sessionId: string, sourceApp: string): HookEvent[] {
  const stmt = db.prepare(`
    SELECT id, source_app, session_id, hook_event_type, payload, chat, summary, timestamp, model_name
    FROM events
    WHERE session_id = ? AND source_app = ?
    ORDER BY timestamp ASC
  `);
  // ... parse rows same as getRecentEvents()
}
```

### Event Categorization
Categorize events for visual treatment:
- **File Read**: `hook_event_type` is `PostToolUse` and `payload.tool_name` is `Read` -- blue left border
- **File Write**: `PostToolUse` + `tool_name` is `Write` -- green left border
- **File Edit**: `PostToolUse` + `tool_name` is `Edit` -- amber left border
- **Bash Command**: `PostToolUse` + `tool_name` is `Bash` -- purple left border
- **Search**: `PostToolUse` + `tool_name` in (`Glob`, `Grep`) -- cyan left border
- **Lifecycle**: `SessionStart`, `SessionEnd`, `Stop` -- gray left border with dashed style
- **Other**: default -- standard border

### Session Stats Calculation
Computed from the fetched events array:
```typescript
const stats = computed(() => ({
  totalEvents: events.length,
  duration: formatDuration(lastTimestamp - firstTimestamp),
  filesRead: events.filter(e => toolName(e) === 'Read').length,
  filesWritten: events.filter(e => toolName(e) === 'Write').length,
  filesEdited: events.filter(e => toolName(e) === 'Edit').length,
  bashCommands: events.filter(e => toolName(e) === 'Bash').length,
  toolBreakdown: buildToolBreakdown(events)
}));
```

### Styling
- Timeline uses a vertical line on the left with event nodes: `border-l-2 border-[var(--theme-border-secondary)] ml-4`
- Event nodes are small circles on the line: `absolute -left-[9px] w-4 h-4 rounded-full border-2`
- Color-coded left borders per event category
- Stats header: horizontal flex of stat cards similar to LivePulseChart stat badges
- Expanded detail: `bg-[var(--theme-bg-tertiary)] rounded-lg p-3 mt-2 font-mono text-xs`

## Tasks
- [ ] Task 1: Add `getEventsForSession(sessionId, sourceApp)` function to `apps/server/src/db.ts` that queries events by session_id + source_app ordered by timestamp ASC
- [ ] Task 2: Add `GET /api/sessions/:sessionId/events` endpoint to `apps/server/src/index.ts` accepting `source_app` query parameter, returning parsed events array
- [ ] Task 3: Create `apps/client/src/components/SessionReplay.vue` with props `sessionId: string` and `sourceApp: string`, fetch events on mount from new endpoint
- [ ] Task 4: Implement session stats header (duration, event count, file read/write/edit counts, tool breakdown)
- [ ] Task 5: Implement chronological event timeline with vertical line, event nodes, and color-coded category borders
- [ ] Task 6: Implement event row detail: collapsed shows type + tool + summary + timestamp; expanded shows full payload (tool_input, tool_result, file paths) in a monospace code block
- [ ] Task 7: Implement Bash command display with truncation at 200 chars and "show more" toggle
- [ ] Task 8: Add "open replay" handler in `DevLogTimeline.vue` that emits a `replay` event with `{ sessionId, sourceApp }`, handle in parent to show SessionReplay
- [ ] Task 9: Modify `apps/client/src/App.vue` to manage replay state -- add a `replaySession` ref that toggles between DevLogTimeline and SessionReplay views

## Files to Create/Modify
| File | Action | Description |
|------|--------|-------------|
| `apps/server/src/db.ts` | Modify | Add `getEventsForSession()` query function |
| `apps/server/src/index.ts` | Modify | Add `GET /api/sessions/:sessionId/events` endpoint |
| `apps/client/src/components/SessionReplay.vue` | Create | Session replay timeline component with stats header and expandable events |
| `apps/client/src/components/DevLogTimeline.vue` | Modify | Add "Replay" button on each log entry that emits `replay` event |
| `apps/client/src/App.vue` | Modify | Add replay state management, toggle between DevLogTimeline and SessionReplay |

## Testing
- [ ] Test 1: `GET /api/sessions/:sessionId/events?source_app=X` returns events ordered by timestamp ASC for the given session
- [ ] Test 2: SessionReplay renders stats header with correct duration, event count, and file operation counts
- [ ] Test 3: Events are displayed in chronological order with correct color-coded borders per category
- [ ] Test 4: Clicking an event row toggles expanded detail view showing payload data
- [ ] Test 5: Bash commands longer than 200 chars are truncated with a working "show more" toggle
- [ ] Test 6: "Back to Dev Logs" button returns to DevLogTimeline view
- [ ] Test 7: Clicking "Replay" on a DevLogTimeline entry transitions to SessionReplay with correct sessionId and sourceApp

## Definition of Done
- [ ] Code compiles without errors (`cd apps/client && bun run build` and `cd apps/server && bun build src/index.ts`)
- [ ] All acceptance criteria met
- [ ] No TypeScript errors
- [ ] Responsive on mobile and desktop
- [ ] Dark/light theme support works via CSS variables
- [ ] Server endpoint returns correctly structured data
