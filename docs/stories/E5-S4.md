# E5-S4: Project Health Dashboard

## Story
**As a** developer overseeing multiple projects
**I want** an aggregate health score per project combining test status, session activity, and error rates
**So that** I can quickly identify which projects need attention and track improvement trends

## Status
- **Epic**: Developer Experience & Productivity
- **Priority**: P2-Medium
- **Points**: 5
- **Sprint**: 6
- **Dependencies**: E5-S3 (uses alert/error rate concepts)

## Acceptance Criteria
- [ ] AC1: Each project card in ProjectOverview.vue displays a health score from 0 to 100 as a color-coded circular ring indicator
- [ ] AC2: Health score color: green (80-100), amber (50-79), red (0-49)
- [ ] AC3: Health score is calculated from three weighted factors: test status (40%), session activity (30%), error rate (30%)
- [ ] AC4: Test status scoring: passing=100, failing=0, unknown=50
- [ ] AC5: Session activity scoring: active sessions present=100, idle sessions only=60, no sessions=30
- [ ] AC6: Error rate scoring: 0 failures=100, then decreases proportionally based on ratio of PostToolUseFailure to total PostToolUse events (e.g., 5% error rate = 95 score, 50% = 50)
- [ ] AC7: A small trend indicator (up arrow, down arrow, or dash) shows whether the score is improving, declining, or stable compared to the previous calculation
- [ ] AC8: Hovering over the health ring shows a tooltip breaking down the three component scores

## Technical Notes

### Architecture
- Health score calculation happens **server-side** in a new function `calculateProjectHealth()` in `apps/server/src/enricher.ts`
- The health data is included in the project object returned by `GET /api/projects`
- The server calculates health scores when broadcasting project updates (after each event and on the idle session check interval)

### Server: Health Calculation
Add to `apps/server/src/enricher.ts`:
```typescript
interface ProjectHealth {
  score: number;           // 0-100
  testScore: number;       // 0-100
  activityScore: number;   // 0-100
  errorRateScore: number;  // 0-100
  trend: 'improving' | 'declining' | 'stable';
  previousScore: number;
}
```

Error rate query:
```sql
SELECT
  COUNT(CASE WHEN hook_event_type = 'PostToolUseFailure' THEN 1 END) as failures,
  COUNT(CASE WHEN hook_event_type IN ('PostToolUse', 'PostToolUseFailure') THEN 1 END) as total
FROM events
WHERE source_app = ? AND timestamp > ? -- last 30 minutes
```

Trend: store previous score in a `project_health` column (JSON) on the projects table. Compare current score to previous. Improving if current > previous + 5, declining if current < previous - 5, stable otherwise.

### Database Migration
Add a `health` column to the `projects` table to persist the health JSON:
```sql
ALTER TABLE projects ADD COLUMN health TEXT DEFAULT '{}';
```
This follows the existing migration pattern in `enricher.ts` where tables are created with `CREATE TABLE IF NOT EXISTS` and columns can be added at init.

### Client: Health Ring Component
- The ring is an SVG circle with `stroke-dasharray` and `stroke-dashoffset` to show the percentage
- Size: 40x40px on desktop, 32x32px on mobile
- The score number displays centered inside the ring
- Trend arrow: small up/down/dash icon next to the ring

### Integration in ProjectOverview.vue
Add the health ring in the card header (next to the project name), replacing or supplementing the simple active/idle badge:
```html
<HealthRing :score="project.health?.score || 50" :trend="project.health?.trend || 'stable'" />
```

Could be inline SVG in ProjectOverview or a separate tiny `HealthRing.vue` component.

## Tasks
- [ ] Task 1: Add `health TEXT DEFAULT '{}'` column to the `projects` table in `apps/server/src/enricher.ts` init (following the existing `CREATE TABLE IF NOT EXISTS` pattern, add an ALTER TABLE migration check)
- [ ] Task 2: Implement `calculateProjectHealth(projectName: string)` function in `apps/server/src/enricher.ts` that queries test_status, active session count, and error rate, returning a `ProjectHealth` object
- [ ] Task 3: Call `calculateProjectHealth()` within `enrichEvent()` after updating project state, and store the result in the `health` column as JSON
- [ ] Task 4: Modify `getAllProjects()` in `apps/server/src/enricher.ts` to parse the `health` JSON column and include it in the returned `Project` objects
- [ ] Task 5: Add `health?: ProjectHealth` field to the `Project` interface in `apps/server/src/types.ts` and the client-side equivalent in `apps/client/src/types.ts`
- [ ] Task 6: Create `apps/client/src/components/HealthRing.vue` -- an SVG-based circular progress ring with score number, color coding (green/amber/red), and trend arrow
- [ ] Task 7: Modify `apps/client/src/components/ProjectOverview.vue` to import HealthRing and display it in each project card header, with a hover tooltip showing component score breakdown

## Files to Create/Modify
| File | Action | Description |
|------|--------|-------------|
| `apps/server/src/enricher.ts` | Modify | Add health column migration, `calculateProjectHealth()` function, integrate into enrichEvent flow |
| `apps/server/src/types.ts` | Modify | Add `ProjectHealth` interface and `health` field to `Project` |
| `apps/client/src/types.ts` | Modify | Add `ProjectHealth` interface for client use |
| `apps/client/src/components/HealthRing.vue` | Create | SVG circular progress ring with score, color, and trend |
| `apps/client/src/components/ProjectOverview.vue` | Modify | Import and render HealthRing in project card headers, add tooltip |

## Testing
- [ ] Test 1: `calculateProjectHealth()` returns score=100 when tests passing, sessions active, and 0 errors
- [ ] Test 2: `calculateProjectHealth()` returns score=0 when tests failing, no sessions, and high error rate
- [ ] Test 3: Health score is correctly weighted: 40% test + 30% activity + 30% error rate
- [ ] Test 4: HealthRing renders green ring for score >= 80, amber for 50-79, red for < 50
- [ ] Test 5: Trend shows "improving" when score increased by more than 5 points from previous
- [ ] Test 6: Hovering over HealthRing shows tooltip with test/activity/error subscores

## Definition of Done
- [ ] Code compiles without errors (both server and client)
- [ ] All acceptance criteria met
- [ ] No TypeScript errors
- [ ] Health scores update in real-time as events arrive
- [ ] Dark/light theme support works via CSS variables
- [ ] Responsive sizing (40px desktop, 32px mobile)
