# E5-S5: Hook Installation Wizard

## Story
**As a** developer wanting to monitor a new project with DevPulse
**I want** an in-app wizard to install Claude Code hooks on any project
**So that** I can onboard new projects without manually running shell scripts or editing configuration files

## Status
- **Epic**: Developer Experience & Productivity
- **Priority**: P2-Medium
- **Points**: 5
- **Sprint**: 6
- **Dependencies**: None

## Acceptance Criteria
- [ ] AC1: A "Add Project" button in the ProjectOverview header opens the HookWizard modal
- [ ] AC2: Step 1 of the wizard collects: project path (text input) and project name (text input with auto-suggestion from directory name)
- [ ] AC3: Step 2 shows a preview of what will be installed: hook scripts to be copied, settings.json content to be generated
- [ ] AC4: Step 3 executes the installation and displays real-time progress with success/failure status for each sub-step
- [ ] AC5: On successful installation, a "Send Test Event" button triggers a test hook event to verify the connection works
- [ ] AC6: If the project path does not exist, a validation error is shown before proceeding
- [ ] AC7: If `.claude/settings.json` already exists in the target, a warning is shown with option to backup and overwrite or cancel
- [ ] AC8: The wizard uses the existing `scripts/install-hooks.sh` by calling a new server endpoint that executes it

## Technical Notes

### Architecture
- New component `HookWizard.vue` renders as a multi-step modal (3 steps)
- New server endpoint `POST /api/install-hooks` accepts `{ projectPath, projectName, serverUrl? }` and runs the install-hooks.sh script
- The server endpoint uses `Bun.spawn()` to execute the shell script and streams output back

### Server Endpoint
Add to `apps/server/src/index.ts`:
```typescript
// POST /api/install-hooks
// Body: { projectPath: string, projectName: string, serverUrl?: string }
// Returns: { success: boolean, output: string, error?: string }
```

Implementation:
```typescript
const proc = Bun.spawn([
  'bash', './scripts/install-hooks.sh',
  body.projectPath,
  body.projectName,
  body.serverUrl || `http://localhost:${server.port}/events`
], {
  cwd: process.cwd(),
  stdout: 'pipe',
  stderr: 'pipe'
});
const stdout = await new Response(proc.stdout).text();
const stderr = await new Response(proc.stderr).text();
const exitCode = await proc.exited;
```

### Validation Endpoint
Add `POST /api/validate-path` to check if a directory exists:
```typescript
// POST /api/validate-path
// Body: { path: string }
// Returns: { exists: boolean, hasSettings: boolean, isGitRepo: boolean, suggestedName: string }
```

Uses `Bun.file()` and `Bun.spawn(['git', 'rev-parse', ...])` to check.

### Test Event Endpoint
Add `POST /api/test-hook` to send a synthetic test event:
```typescript
// POST /api/test-hook
// Body: { projectName: string }
// Inserts a test event with hook_event_type: 'TestHook' and broadcasts it
```

### Client: Multi-Step Wizard
The wizard uses a `currentStep` ref (1, 2, 3) to show different content:
- Step 1: Form inputs + validation
- Step 2: Preview (read-only display of what will happen)
- Step 3: Progress log (streaming output lines)

### Styling
- Modal overlay: same pattern as ThemeManager.vue (`fixed inset-0 z-50`)
- Step indicator: horizontal dots/progress bar at top
- Form inputs: `bg-[var(--theme-bg-secondary)] border border-[var(--theme-border-primary)] rounded-lg`
- Progress log: `bg-[var(--theme-bg-tertiary)] font-mono text-xs p-3 rounded-lg max-h-64 overflow-y-auto`
- Success: `text-[var(--theme-accent-success)]` with checkmark
- Error: `text-[var(--theme-accent-error)]` with X mark

## Tasks
- [ ] Task 1: Add `POST /api/validate-path` endpoint to `apps/server/src/index.ts` that checks if directory exists, whether .claude/settings.json exists, whether it is a git repo, and suggests a project name from the directory basename
- [ ] Task 2: Add `POST /api/install-hooks` endpoint to `apps/server/src/index.ts` that executes `scripts/install-hooks.sh` via `Bun.spawn()` with the provided projectPath, projectName, and serverUrl, returning stdout/stderr and exit code
- [ ] Task 3: Add `POST /api/test-hook` endpoint to `apps/server/src/index.ts` that inserts a synthetic test event for the given projectName and broadcasts it via WebSocket
- [ ] Task 4: Create `apps/client/src/components/HookWizard.vue` with 3-step modal: Step 1 (form with path + name inputs, validate on blur), Step 2 (preview of installation actions), Step 3 (execution progress with output log)
- [ ] Task 5: Implement path validation in Step 1 -- call `POST /api/validate-path` on blur, show errors for missing directory, show warning for existing settings.json
- [ ] Task 6: Implement Step 3 execution -- call `POST /api/install-hooks`, display output lines in a scrolling monospace log area, show success/failure status
- [ ] Task 7: Add "Send Test Event" button in Step 3 success state that calls `POST /api/test-hook` and confirms the event appeared
- [ ] Task 8: Modify `apps/client/src/components/ProjectOverview.vue` to add an "Add Project" button in the header that emits an `add-project` event, handled by App.vue to open the wizard
- [ ] Task 9: Modify `apps/client/src/App.vue` to import HookWizard, manage its open/close state, and render it at the root level

## Files to Create/Modify
| File | Action | Description |
|------|--------|-------------|
| `apps/server/src/index.ts` | Modify | Add three new endpoints: validate-path, install-hooks, test-hook |
| `apps/client/src/components/HookWizard.vue` | Create | Multi-step installation wizard modal |
| `apps/client/src/components/ProjectOverview.vue` | Modify | Add "Add Project" button in header |
| `apps/client/src/App.vue` | Modify | Import HookWizard, manage open/close state |

## Testing
- [ ] Test 1: `POST /api/validate-path` returns `{ exists: true }` for a valid directory and `{ exists: false }` for invalid
- [ ] Test 2: `POST /api/validate-path` returns `{ hasSettings: true }` when `.claude/settings.json` exists in the target
- [ ] Test 3: `POST /api/install-hooks` executes the shell script and returns success with output when given valid inputs
- [ ] Test 4: `POST /api/install-hooks` returns error when project path does not exist
- [ ] Test 5: `POST /api/test-hook` inserts a test event that appears in the WebSocket stream
- [ ] Test 6: Wizard Step 1 shows validation error for non-existent directory path
- [ ] Test 7: Wizard completes full flow: enter path/name -> preview -> install -> test event succeeds

## Definition of Done
- [ ] Code compiles without errors (both server and client)
- [ ] All acceptance criteria met
- [ ] No TypeScript errors
- [ ] Wizard is responsive on mobile and desktop
- [ ] Dark/light theme support works via CSS variables
- [ ] Installation works for projects that do not already have hooks
- [ ] Existing settings.json backup mechanism works correctly
