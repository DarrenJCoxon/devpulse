# E6-S1: Activity Heatmap

## Story
**As a** developer reviewing my coding patterns
**I want** a calendar-style heatmap showing when development activity occurs across days and hours
**So that** I can visualize productivity patterns, identify peak working hours, and understand workload distribution over time

## Status
- **Epic**: Data & Reporting
- **Priority**: P2-Medium
- **Points**: 5
- **Sprint**: 6
- **Dependencies**: None (uses existing events table timestamps)

## Acceptance Criteria
- [ ] AC1: A heatmap visualization displays a grid where X-axis is days (last 30 days by default) and Y-axis is hours of day (0-23)
- [ ] AC2: Each cell's color intensity represents the number of events in that hour slot -- darker = more activity
- [ ] AC3: Hovering over a cell shows a tooltip with the exact date, hour range, and event count
- [ ] AC4: A project filter dropdown above the heatmap filters activity to a specific project (or "All Projects")
- [ ] AC5: The heatmap uses a single-hue color scale based on the theme primary color (from transparent to full `var(--theme-primary)`)
- [ ] AC6: A legend below the heatmap shows the color scale from "0 events" to "max events"
- [ ] AC7: Day labels on X-axis show abbreviated weekday names; hour labels on Y-axis show 12h format (12am, 6am, 12pm, 6pm)
- [ ] AC8: The heatmap data is fetched from a new server endpoint that returns aggregated event counts by day and hour

## Technical Notes

### Architecture
- New component `ActivityHeatmap.vue` using Canvas rendering (following `LivePulseChart.vue` pattern with the `chartRenderer.ts` utility style)
- New server endpoint `GET /api/analytics/heatmap` returns pre-aggregated data to avoid heavy client-side computation
- The heatmap is a standalone view, likely shown in a future "Analytics" tab or rendered below ProjectOverview

### Server Endpoint
Add to `apps/server/src/index.ts`:
```typescript
// GET /api/analytics/heatmap?project=name&days=30
// Returns: { cells: Array<{ day: string, hour: number, count: number }>, maxCount: number }
```

Query (SQLite):
```sql
SELECT
  date(timestamp/1000, 'unixepoch', 'localtime') as day,
  CAST(strftime('%H', timestamp/1000, 'unixepoch', 'localtime') AS INTEGER) as hour,
  COUNT(*) as count
FROM events
WHERE timestamp > ?  -- (now - days * 86400000)
  AND (? IS NULL OR source_app = ?)  -- optional project filter
GROUP BY day, hour
ORDER BY day, hour
```

### Canvas Rendering
Follow the `LivePulseChart.vue` + `chartRenderer.ts` pattern:
- Create the canvas in the component template
- Use a rendering function that draws the grid, cells, labels, and legend
- Cell size: `(canvasWidth - leftPadding - rightPadding) / numDays` wide, `(canvasHeight - topPadding - bottomPadding) / 24` tall
- Color interpolation: `rgba(primaryR, primaryG, primaryB, count / maxCount)` for smooth scaling
- Use `getComputedStyle` to read `var(--theme-primary)` and parse to RGB for the color scale

### Grid Layout
```
         Mon  Tue  Wed  Thu  Fri  Sat  Sun  Mon  Tue  ...
12am  [   ] [   ] [   ] [   ] [   ] [   ] [   ] [   ] [   ]
 1am  [   ] [   ] [   ] [   ] [   ] [   ] [   ] [   ] [   ]
 ...
11pm  [   ] [   ] [   ] [   ] [   ] [   ] [   ] [   ] [   ]
```

### Styling
- Container: `bg-[var(--theme-bg-primary)] rounded-xl border border-[var(--theme-border-primary)] p-4`
- Filter dropdown: same pattern as `FilterPanel.vue` select elements
- Tooltip: `bg-[var(--theme-primary)] text-white rounded-lg px-3 py-2 text-xs font-bold shadow-lg` (same as LivePulseChart tooltip)
- Legend: horizontal gradient bar with "Less" and "More" labels

## Tasks
- [ ] Task 1: Add `GET /api/analytics/heatmap` endpoint to `apps/server/src/index.ts` that queries events grouped by day + hour, accepts optional `project` and `days` query parameters
- [ ] Task 2: Create `apps/client/src/components/ActivityHeatmap.vue` with canvas element, project filter dropdown, and tooltip overlay
- [ ] Task 3: Implement canvas rendering function: draw grid cells with color intensity based on event count, using theme primary color with opacity scaling
- [ ] Task 4: Implement X-axis day labels (abbreviated weekday + date) and Y-axis hour labels (12h format) drawn on canvas
- [ ] Task 5: Implement hover interaction: mouse position maps to grid cell, tooltip shows date/hour/count, hovered cell gets a border highlight
- [ ] Task 6: Implement the color scale legend below the heatmap (canvas-drawn gradient bar with "Less" / "More" labels)
- [ ] Task 7: Implement project filter dropdown that re-fetches heatmap data when changed
- [ ] Task 8: Add `onMounted` data fetch and `ResizeObserver` for responsive canvas sizing (following LivePulseChart.vue pattern at lines 439-479)

## Files to Create/Modify
| File | Action | Description |
|------|--------|-------------|
| `apps/server/src/index.ts` | Modify | Add `GET /api/analytics/heatmap` endpoint |
| `apps/client/src/components/ActivityHeatmap.vue` | Create | Canvas-based heatmap with filter, tooltip, and legend |

## Testing
- [ ] Test 1: `GET /api/analytics/heatmap` returns correctly structured `{ cells, maxCount }` data
- [ ] Test 2: `GET /api/analytics/heatmap?project=X` filters results to only events from project X
- [ ] Test 3: Heatmap renders a grid with 24 rows and correct number of day columns
- [ ] Test 4: Cells with higher event counts render with darker color intensity
- [ ] Test 5: Hovering over a cell displays a tooltip with correct date, hour, and count
- [ ] Test 6: Changing the project filter re-renders the heatmap with filtered data
- [ ] Test 7: Heatmap resizes correctly when the browser window is resized

## Definition of Done
- [ ] Code compiles without errors (both server and client)
- [ ] All acceptance criteria met
- [ ] No TypeScript errors
- [ ] Responsive canvas sizing works on different screen widths
- [ ] Dark/light theme support works (color scale uses theme primary)
- [ ] Empty state shown when no events exist in the date range
