# E6-S2: Export & Sharing

## Story
**As a** developer or team lead
**I want** to export dev logs and session data as Markdown reports, JSON files, or shareable HTML
**So that** I can share progress updates with stakeholders, archive session history, and integrate with other tools

## Status
- **Epic**: Data & Reporting
- **Priority**: P2-Medium
- **Points**: 5
- **Sprint**: 6
- **Dependencies**: E1-S1 (DevLogTimeline must exist for export button placement)

## Acceptance Criteria
- [ ] AC1: A download/export button in DevLogTimeline header offers three format options: Markdown, JSON, and HTML Report
- [ ] AC2: Export scope options: "This Session" (single dev log), "This Project" (all logs for current project filter), "Date Range" (custom start/end dates), or "All" (everything)
- [ ] AC3: Markdown export produces a readable report with headers, bullet points for files changed, commit messages, and tool usage stats
- [ ] AC4: JSON export produces a machine-readable file with the raw DevLog objects array
- [ ] AC5: HTML export produces a self-contained HTML file with embedded CSS that can be opened in any browser -- styled similarly to the dashboard
- [ ] AC6: Exported files are downloaded directly in the browser (no server-side file storage needed for Markdown and JSON)
- [ ] AC7: HTML report generation is done server-side via a new endpoint that returns the rendered HTML
- [ ] AC8: A "Copy as Markdown" option copies the report content to clipboard instead of downloading

## Technical Notes

### Architecture
- Client-side: Markdown and JSON exports are generated entirely in the browser using the data already available in props/fetched from API
- Server-side: HTML report uses a new endpoint `GET /api/export/report` that generates a styled HTML document
- Export UI: a dropdown menu on the DevLogTimeline header (button + popover with options)

### Client-Side Export (Markdown)
```typescript
function generateMarkdown(logs: DevLog[], title: string): string {
  let md = `# DevPulse Report: ${title}\n\n`;
  md += `Generated: ${new Date().toISOString()}\n\n`;

  for (const log of logs) {
    md += `## ${log.project_name} - ${log.branch}\n`;
    md += `**Session:** ${log.session_id.slice(0, 8)} | `;
    md += `**Duration:** ${log.duration_minutes}m | `;
    md += `**Events:** ${log.event_count}\n\n`;
    md += `${log.summary}\n\n`;

    const files = JSON.parse(log.files_changed || '[]');
    if (files.length > 0) {
      md += `### Files Changed\n`;
      files.forEach((f: string) => { md += `- \`${f}\`\n`; });
      md += '\n';
    }
    // ... commits, tool breakdown
  }
  return md;
}
```

### Client-Side Export (JSON)
Simply `JSON.stringify(logs, null, 2)` and trigger download.

### Download Trigger
```typescript
function downloadFile(content: string, filename: string, mimeType: string) {
  const blob = new Blob([content], { type: mimeType });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}
```

### Server-Side Endpoint (HTML Report)
Add to `apps/server/src/index.ts`:
```typescript
// GET /api/export/report?project=name&from=timestamp&to=timestamp&format=html
// Returns: HTML document with Content-Type: text/html
```

The HTML template embeds inline CSS styled to match the dashboard look (card layout, monospace code blocks, color-coded sections). Data is embedded as JSON in a `<script>` tag and rendered with vanilla JS.

### Copy to Clipboard
Use `navigator.clipboard.writeText(markdown)` with a fallback to `document.execCommand('copy')`.

### Export Dropdown UI
- A button with a download icon in the DevLogTimeline header
- Clicking opens a small dropdown/popover with format and scope options
- Scope selector: radio buttons for session/project/range/all
- Date range: two date inputs shown when "Date Range" is selected
- Format buttons: Markdown, JSON, HTML, Copy

### Styling
- Dropdown: `bg-[var(--theme-bg-primary)] border border-[var(--theme-border-primary)] rounded-lg shadow-xl p-3`
- Option buttons: `bg-[var(--theme-bg-tertiary)] hover:bg-[var(--theme-primary)]/10 rounded px-3 py-2 text-sm`
- Active/selected: `border-[var(--theme-primary)] bg-[var(--theme-primary)]/5`

## Tasks
- [ ] Task 1: Create export utility functions in `apps/client/src/utils/exportHelpers.ts`: `generateMarkdown(logs, title)`, `generateJSON(logs)`, and `downloadFile(content, filename, mimeType)`
- [ ] Task 2: Add `GET /api/export/report` endpoint to `apps/server/src/index.ts` that accepts `project`, `from`, `to` query params, fetches dev logs, and returns a self-contained HTML document with inline CSS
- [ ] Task 3: Create `apps/client/src/components/ExportDropdown.vue` with scope selector (single/project/range/all), date range inputs, and format buttons (Markdown/JSON/HTML/Copy)
- [ ] Task 4: Implement Markdown export in ExportDropdown: fetch dev logs based on selected scope, generate markdown using `generateMarkdown()`, trigger download
- [ ] Task 5: Implement JSON export: fetch dev logs, `JSON.stringify`, trigger download
- [ ] Task 6: Implement HTML export: call `GET /api/export/report` with scope parameters, trigger download of returned HTML
- [ ] Task 7: Implement "Copy as Markdown" using `navigator.clipboard.writeText()` with success toast notification
- [ ] Task 8: Modify `apps/client/src/components/DevLogTimeline.vue` to add an export button in the header that opens ExportDropdown
- [ ] Task 9: Add project-scoped export button in `apps/client/src/components/ProjectOverview.vue` on each project card (exports logs for that specific project)

## Files to Create/Modify
| File | Action | Description |
|------|--------|-------------|
| `apps/client/src/utils/exportHelpers.ts` | Create | Markdown/JSON generation functions and download trigger utility |
| `apps/server/src/index.ts` | Modify | Add `GET /api/export/report` endpoint for HTML report generation |
| `apps/client/src/components/ExportDropdown.vue` | Create | Export options dropdown with scope selector and format buttons |
| `apps/client/src/components/DevLogTimeline.vue` | Modify | Add export button in header that opens ExportDropdown |
| `apps/client/src/components/ProjectOverview.vue` | Modify | Add per-project export button on cards |

## Testing
- [ ] Test 1: `generateMarkdown()` produces valid Markdown with project headers, session details, file lists, and tool breakdowns
- [ ] Test 2: `generateJSON()` produces valid JSON that can be parsed back into DevLog objects
- [ ] Test 3: `downloadFile()` triggers a browser download with the correct filename and MIME type
- [ ] Test 4: `GET /api/export/report` returns a valid HTML document that renders correctly when opened standalone
- [ ] Test 5: `GET /api/export/report?project=X` only includes dev logs for project X
- [ ] Test 6: "Copy as Markdown" copies text to clipboard (verify with navigator.clipboard.readText in test)
- [ ] Test 7: Date range export only includes logs within the specified from/to timestamps

## Definition of Done
- [ ] Code compiles without errors (both server and client)
- [ ] All acceptance criteria met
- [ ] No TypeScript errors
- [ ] Exported Markdown renders correctly in GitHub/standard Markdown viewers
- [ ] Exported HTML is self-contained (no external dependencies)
- [ ] Dark/light theme support works for the export UI
- [ ] Download works in Chrome, Safari, and Firefox
