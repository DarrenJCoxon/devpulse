# E6-S3: Advanced Search & Saved Filters

## Story
**As a** developer investigating specific events or patterns across sessions
**I want** full-text search across events, dev logs, and sessions with the ability to save filter presets
**So that** I can quickly find relevant information and reuse common search queries without reconfiguring filters each time

## Status
- **Epic**: Data & Reporting
- **Priority**: P2-Medium
- **Points**: 5
- **Sprint**: 7
- **Dependencies**: None (extends existing FilterPanel.vue and useEventSearch.ts)

## Acceptance Criteria
- [ ] AC1: A search input at the top of the dashboard performs full-text search across event payloads, dev log summaries, and session data
- [ ] AC2: Search results are grouped by type: Events (matching payload content), Sessions (matching session_id, source_app, branch), and Dev Logs (matching summary, files_changed)
- [ ] AC3: Each result group shows a count and the top 5 results; clicking "Show all" expands to full results
- [ ] AC4: Filter combinations (search query + source_app + session_id + event_type) can be saved as named presets stored in localStorage
- [ ] AC5: Saved presets appear as quick-access chips below the search input; clicking a chip applies that filter combination
- [ ] AC6: Presets can be renamed and deleted via a small management dropdown
- [ ] AC7: Search supports regex patterns (existing `useEventSearch.ts` pattern) with a toggle to switch between simple text and regex mode
- [ ] AC8: Server-side search endpoint performs SQLite LIKE queries across event payload, dev log summary, and session fields

## Technical Notes

### Architecture
- Extend the existing `FilterPanel.vue` with a prominent search input and preset chips
- New component `SearchPanel.vue` for the grouped results display (renders below FilterPanel when search is active)
- New server endpoint `GET /api/search` for server-side full-text search
- Saved presets stored in `localStorage` under key `devpulse-saved-filters`

### Server Endpoint
Add to `apps/server/src/index.ts`:
```typescript
// GET /api/search?q=query&type=events|sessions|devlogs|all&limit=20
// Returns: {
//   events: { count: number, results: HookEvent[] },
//   sessions: { count: number, results: Session[] },
//   devlogs: { count: number, results: DevLog[] }
// }
```

SQLite queries:
```sql
-- Events search (payload is stored as JSON text)
SELECT * FROM events
WHERE payload LIKE '%' || ? || '%'
   OR summary LIKE '%' || ? || '%'
   OR source_app LIKE '%' || ? || '%'
ORDER BY timestamp DESC LIMIT ?

-- Dev logs search
SELECT * FROM dev_logs
WHERE summary LIKE '%' || ? || '%'
   OR files_changed LIKE '%' || ? || '%'
   OR project_name LIKE '%' || ? || '%'
ORDER BY ended_at DESC LIMIT ?

-- Sessions search
SELECT * FROM sessions
WHERE session_id LIKE '%' || ? || '%'
   OR source_app LIKE '%' || ? || '%'
   OR project_name LIKE '%' || ? || '%'
   OR current_branch LIKE '%' || ? || '%'
ORDER BY last_event_at DESC LIMIT ?
```

### Saved Filters Structure
```typescript
interface SavedFilter {
  id: string;              // UUID
  name: string;            // User-provided name
  query: string;           // Search text
  sourceApp: string;       // Filter value
  sessionId: string;       // Filter value
  eventType: string;       // Filter value
  createdAt: number;
}
```

localStorage key: `devpulse-saved-filters`
Value: `JSON.stringify(SavedFilter[])`

### Client-Side vs Server-Side Search
- For the EventTimeline (real-time events in memory), continue using the existing `useEventSearch.ts` client-side regex matching
- For historical search across all data (full database), use the new server endpoint
- The SearchPanel shows results from the server endpoint
- The FilterPanel continues to use client-side filtering for the live event stream

### Integration Points
- The search input lives in a new `SearchPanel.vue` that sits between the FilterPanel and LivePulseChart
- FilterPanel gains a "Save current filters" button and a preset chip bar
- `useEventSearch.ts` is extended (not replaced) with a `savedFilters` ref using localStorage

### Styling
- Search input: large, prominent, full-width with search icon -- `bg-[var(--theme-bg-primary)] border-2 border-[var(--theme-primary)]/30 focus:border-[var(--theme-primary)] rounded-xl px-4 py-3 text-lg`
- Preset chips: `bg-[var(--theme-primary)]/10 text-[var(--theme-primary)] rounded-full px-3 py-1 text-sm font-medium hover:bg-[var(--theme-primary)]/20`
- Result groups: card-style containers with count badges
- Group headers: `text-sm font-bold text-[var(--theme-text-primary)]` with result count in a pill badge

## Tasks
- [ ] Task 1: Add `GET /api/search` endpoint to `apps/server/src/index.ts` that performs LIKE queries across events, sessions, and dev_logs tables, returning grouped results with counts
- [ ] Task 2: Create `apps/client/src/components/SearchPanel.vue` with a prominent search input, regex toggle, and grouped results display (Events, Sessions, Dev Logs sections)
- [ ] Task 3: Implement result grouping in SearchPanel: each group shows count badge, top 5 results, and "Show all N results" expansion button
- [ ] Task 4: Extend `apps/client/src/composables/useEventSearch.ts` to add `savedFilters` ref with localStorage persistence, `saveFilter(name, filters)`, `deleteFilter(id)`, and `loadFilter(id)` functions
- [ ] Task 5: Modify `apps/client/src/components/FilterPanel.vue` to add a "Save" button that opens a name input dialog, and a preset chips bar showing saved filters below the dropdowns
- [ ] Task 6: Implement preset chip interactions: clicking applies the filter, right-click or long-press shows rename/delete options
- [ ] Task 7: Modify `apps/client/src/App.vue` to import SearchPanel, render it conditionally (shown when search is active), and pass search-related state

## Files to Create/Modify
| File | Action | Description |
|------|--------|-------------|
| `apps/server/src/index.ts` | Modify | Add `GET /api/search` endpoint with LIKE queries across events, sessions, dev_logs |
| `apps/client/src/components/SearchPanel.vue` | Create | Search input + grouped results display |
| `apps/client/src/composables/useEventSearch.ts` | Modify | Add saved filters with localStorage, save/delete/load functions |
| `apps/client/src/components/FilterPanel.vue` | Modify | Add "Save" button and preset chips bar |
| `apps/client/src/App.vue` | Modify | Import SearchPanel, manage search state |

## Testing
- [ ] Test 1: `GET /api/search?q=Write` returns events where payload contains "Write" and dev logs where files_changed contains matching entries
- [ ] Test 2: `GET /api/search?q=main&type=sessions` returns only sessions matching "main" in branch or other fields
- [ ] Test 3: Saving a filter stores it in localStorage and the preset chip appears immediately
- [ ] Test 4: Clicking a preset chip applies the saved filter combination to FilterPanel
- [ ] Test 5: Deleting a preset removes it from localStorage and the chip disappears
- [ ] Test 6: Regex toggle changes search behavior from simple substring to regex pattern matching
- [ ] Test 7: "Show all" button in a result group expands to show all results (not just top 5)

## Definition of Done
- [ ] Code compiles without errors (both server and client)
- [ ] All acceptance criteria met
- [ ] No TypeScript errors
- [ ] Saved filters persist across page reloads (localStorage)
- [ ] Search is debounced (300ms) to avoid excessive API calls
- [ ] Dark/light theme support works via CSS variables
- [ ] Responsive layout on mobile (search input stacks above results)
