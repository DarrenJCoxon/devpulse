# E6-S4: Data Retention & Archival

## Story
**As a** DevPulse administrator
**I want** configurable data retention policies with automatic archival of old events
**So that** the database stays performant, disk usage is controlled, and historical data is preserved in exportable archive files

## Status
- **Epic**: Data & Reporting
- **Priority**: P2-Medium
- **Points**: 5
- **Sprint**: 7
- **Dependencies**: E6-S2 (export utilities for archive format)

## Acceptance Criteria
- [ ] AC1: A settings UI allows configuring retention period (default 30 days) for events, dev logs, and sessions
- [ ] AC2: A scheduled server-side cleanup job runs daily and removes events older than the retention period
- [ ] AC3: Before deletion, old data is exported to JSON archive files in a configurable archive directory
- [ ] AC4: Archive files are named with date range: `devpulse-archive-2026-01-01-to-2026-01-15.json`
- [ ] AC5: An admin stats endpoint shows database size, total event count, oldest event date, and archive file count
- [ ] AC6: A manual "Run Cleanup Now" button in settings triggers an immediate cleanup with progress feedback
- [ ] AC7: After cleanup, SQLite VACUUM is run to reclaim disk space
- [ ] AC8: Retention settings are persisted in a server-side configuration file or database table

## Technical Notes

### Architecture
- Server-side: new module `apps/server/src/retention.ts` handles archival and cleanup logic
- Settings stored in a new `settings` table in SQLite (key-value pairs)
- Cleanup runs on a daily interval (configurable) using `setInterval` in `index.ts`
- Client-side: new `RetentionSettings.vue` component for configuration UI

### Database: Settings Table
Add in `apps/server/src/db.ts` or `enricher.ts` init:
```sql
CREATE TABLE IF NOT EXISTS settings (
  key TEXT PRIMARY KEY,
  value TEXT NOT NULL,
  updated_at INTEGER NOT NULL
);
```

Default settings:
```typescript
const DEFAULT_SETTINGS = {
  'retention.events.days': '30',
  'retention.devlogs.days': '90',
  'retention.sessions.days': '30',
  'retention.archive.enabled': 'true',
  'retention.archive.directory': './archives',
  'retention.cleanup.interval.hours': '24'
};
```

### Server: Retention Module
New file `apps/server/src/retention.ts`:
```typescript
export async function runCleanup(db: Database, settings: Record<string, string>): Promise<CleanupResult> {
  const retentionDays = parseInt(settings['retention.events.days'] || '30');
  const archiveEnabled = settings['retention.archive.enabled'] === 'true';
  const archiveDir = settings['retention.archive.directory'] || './archives';
  const cutoff = Date.now() - (retentionDays * 86400000);

  // 1. Count records to archive
  const eventCount = db.prepare('SELECT COUNT(*) as count FROM events WHERE timestamp < ?').get(cutoff);

  // 2. If archive enabled, export to JSON
  if (archiveEnabled && eventCount.count > 0) {
    const events = db.prepare('SELECT * FROM events WHERE timestamp < ? ORDER BY timestamp ASC').all(cutoff);
    const archivePath = `${archiveDir}/devpulse-archive-${formatDateRange(cutoff)}.json`;
    await Bun.write(archivePath, JSON.stringify({ events, exportedAt: Date.now() }));
  }

  // 3. Delete old records
  db.prepare('DELETE FROM events WHERE timestamp < ?').run(cutoff);
  db.prepare('DELETE FROM dev_logs WHERE ended_at < ?').run(cutoff);
  db.prepare("DELETE FROM sessions WHERE status = 'stopped' AND last_event_at < ?").run(cutoff);

  // 4. VACUUM
  db.exec('VACUUM');

  return { eventsArchived, eventsDeleted, ... };
}
```

### Server Endpoints
```typescript
// GET /api/admin/stats
// Returns: { dbSizeBytes, eventCount, oldestEvent, newestEvent, archiveCount, archiveFiles }

// POST /api/admin/cleanup
// Triggers immediate cleanup, returns CleanupResult

// GET /api/admin/settings
// Returns current retention settings

// PUT /api/admin/settings
// Updates retention settings
// Body: { key: string, value: string }[]
```

### Client: RetentionSettings Component
- A settings panel (could be a modal or a section in a future Settings tab)
- Form fields for each setting with labels and descriptions
- "Run Cleanup Now" button with a loading spinner and result display
- Stats display: database size, event count, oldest event, archive count

### Styling
- Settings form: standard form layout with `bg-[var(--theme-bg-primary)]` cards
- Input fields: `bg-[var(--theme-bg-secondary)] border border-[var(--theme-border-primary)] rounded-lg px-3 py-2`
- Danger zone (cleanup button): `bg-[var(--theme-accent-error)]/10 border border-[var(--theme-accent-error)]/30 rounded-lg p-4`
- Stats: horizontal stat cards similar to LivePulseChart summary badges

## Tasks
- [ ] Task 1: Add `settings` table creation to `apps/server/src/db.ts` with key/value schema, and helper functions `getSetting(key)`, `setSetting(key, value)`, `getAllSettings()`
- [ ] Task 2: Create `apps/server/src/retention.ts` with `runCleanup(db, settings)` function that archives old data to JSON files and deletes expired records from events, dev_logs, and sessions tables, then runs VACUUM
- [ ] Task 3: Add `GET /api/admin/stats` endpoint to `apps/server/src/index.ts` that returns database file size (using `Bun.file('events.db').size`), event count, oldest/newest event timestamps, and archive file count
- [ ] Task 4: Add `POST /api/admin/cleanup` endpoint that calls `runCleanup()` and returns the result (events archived, deleted, new DB size)
- [ ] Task 5: Add `GET /api/admin/settings` and `PUT /api/admin/settings` endpoints for reading and updating retention settings
- [ ] Task 6: Set up daily cleanup interval in `apps/server/src/index.ts` (reading interval from settings, defaulting to 24 hours)
- [ ] Task 7: Create `apps/client/src/components/RetentionSettings.vue` with settings form (retention days, archive toggle, archive directory), stats display, and "Run Cleanup Now" button with loading/result state
- [ ] Task 8: Modify `apps/client/src/App.vue` to add a way to access RetentionSettings (e.g., gear icon in header or a settings modal)

## Files to Create/Modify
| File | Action | Description |
|------|--------|-------------|
| `apps/server/src/db.ts` | Modify | Add `settings` table and CRUD helper functions |
| `apps/server/src/retention.ts` | Create | Archival and cleanup logic: export to JSON, delete old records, VACUUM |
| `apps/server/src/index.ts` | Modify | Add admin endpoints (stats, cleanup, settings), set up daily cleanup interval |
| `apps/client/src/components/RetentionSettings.vue` | Create | Settings UI with form, stats display, and manual cleanup trigger |
| `apps/client/src/App.vue` | Modify | Add settings access point (gear icon or menu item) |

## Testing
- [ ] Test 1: `getSetting()` returns default value when setting does not exist, and stored value when it does
- [ ] Test 2: `runCleanup()` archives events older than retention period to a JSON file in the archive directory
- [ ] Test 3: `runCleanup()` deletes events, dev_logs, and stopped sessions older than their respective retention periods
- [ ] Test 4: Archive file contains valid JSON with correct event data
- [ ] Test 5: `GET /api/admin/stats` returns accurate database size and record counts
- [ ] Test 6: `POST /api/admin/cleanup` triggers cleanup and returns result with counts
- [ ] Test 7: `PUT /api/admin/settings` persists new retention values that are used on next cleanup
- [ ] Test 8: VACUUM runs successfully after deletion (database file size decreases or stays same)

## Definition of Done
- [ ] Code compiles without errors (both server and client)
- [ ] All acceptance criteria met
- [ ] No TypeScript errors
- [ ] Cleanup job runs without blocking the event ingestion pipeline
- [ ] Archive files are valid JSON and can be imported back if needed
- [ ] Dark/light theme support works for the settings UI
- [ ] Settings persist across server restarts
