# E6-S5: API Documentation & Webhook Support

## Story
**As a** developer or integration builder
**I want** documented REST and WebSocket APIs plus outgoing webhook support
**So that** I can integrate DevPulse with external tools like Slack, Discord, and custom services to receive real-time notifications

## Status
- **Epic**: Data & Reporting
- **Priority**: P2-Medium
- **Points**: 8
- **Sprint**: 7
- **Dependencies**: None

## Acceptance Criteria
- [ ] AC1: An in-app API documentation page lists all REST endpoints with method, path, query parameters, request body schema, and response schema
- [ ] AC2: WebSocket message types are documented with their data shapes
- [ ] AC3: A webhook configuration UI allows creating, editing, enabling/disabling, and deleting webhook targets
- [ ] AC4: Each webhook target specifies: URL, event types to forward (multi-select from all hook_event_types), optional project filter, and active/inactive toggle
- [ ] AC5: When an event is received that matches a webhook's filters, the event payload is POSTed to the webhook URL with a configurable timeout (5 seconds default)
- [ ] AC6: Webhook delivery failures are logged with status code and error message, viewable in the webhook management UI
- [ ] AC7: A "Test" button on each webhook sends a test payload to verify the URL is reachable and returns 2xx
- [ ] AC8: Webhook payloads include a `X-DevPulse-Event` header with the event type and a `X-DevPulse-Signature` header with an HMAC-SHA256 signature using a configurable secret

## Technical Notes

### Architecture
- New database table `webhooks` for webhook configuration
- New server module `apps/server/src/webhooks.ts` for webhook delivery logic
- New client components for webhook management UI and API docs display
- API docs are generated from a static definition object (not auto-generated from code)

### Database: Webhooks Table
Add in `apps/server/src/db.ts`:
```sql
CREATE TABLE IF NOT EXISTS webhooks (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  url TEXT NOT NULL,
  secret TEXT DEFAULT '',
  event_types TEXT NOT NULL DEFAULT '[]',  -- JSON array of event type strings
  project_filter TEXT DEFAULT '',           -- Empty = all projects
  active INTEGER NOT NULL DEFAULT 1,
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL,
  last_triggered_at INTEGER,
  last_status INTEGER,                      -- HTTP status code
  last_error TEXT,
  trigger_count INTEGER DEFAULT 0,
  failure_count INTEGER DEFAULT 0
);
```

### Server: Webhooks Module
New file `apps/server/src/webhooks.ts`:
```typescript
export async function triggerWebhooks(db: Database, event: HookEvent): Promise<void> {
  const webhooks = db.prepare(
    "SELECT * FROM webhooks WHERE active = 1"
  ).all() as Webhook[];

  for (const webhook of webhooks) {
    const eventTypes: string[] = JSON.parse(webhook.event_types || '[]');

    // Check event type filter
    if (eventTypes.length > 0 && !eventTypes.includes(event.hook_event_type)) continue;

    // Check project filter
    if (webhook.project_filter && event.source_app !== webhook.project_filter) continue;

    // Fire and forget (with error handling)
    deliverWebhook(webhook, event).catch(err => {
      console.error(`[Webhook] Failed to deliver to ${webhook.url}:`, err);
    });
  }
}

async function deliverWebhook(webhook: Webhook, event: HookEvent): Promise<void> {
  const payload = JSON.stringify({
    event_type: event.hook_event_type,
    source_app: event.source_app,
    session_id: event.session_id,
    timestamp: event.timestamp,
    payload: event.payload,
    summary: event.summary
  });

  const signature = createHmacSignature(payload, webhook.secret);

  const response = await fetch(webhook.url, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-DevPulse-Event': event.hook_event_type,
      'X-DevPulse-Signature': `sha256=${signature}`,
      'User-Agent': 'DevPulse-Webhook/1.0'
    },
    body: payload,
    signal: AbortSignal.timeout(5000)
  });

  // Update webhook stats
  updateWebhookStatus(webhook.id, response.status, response.ok ? null : response.statusText);
}
```

### HMAC Signature
```typescript
function createHmacSignature(payload: string, secret: string): string {
  if (!secret) return '';
  const hmac = new Bun.CryptoHasher('sha256', secret);
  hmac.update(payload);
  return hmac.digest('hex');
}
```

### Server Endpoints
```typescript
// CRUD for webhooks
// GET /api/webhooks - List all webhooks
// POST /api/webhooks - Create webhook { name, url, secret?, eventTypes, projectFilter? }
// PUT /api/webhooks/:id - Update webhook
// DELETE /api/webhooks/:id - Delete webhook
// POST /api/webhooks/:id/test - Send test payload to webhook URL

// API docs
// GET /api/docs - Return API documentation JSON (static definition)
```

### Integration in Event Pipeline
In `apps/server/src/index.ts`, after event insertion and enrichment:
```typescript
// After insertEvent and enrichEvent...
triggerWebhooks(getDb(), savedEvent).catch(err => {
  console.error('[Webhook] Error:', err);
});
```

### Client: Webhook Management UI
- `WebhookManager.vue` -- list of configured webhooks with add/edit/delete/test actions
- Each webhook row shows: name, URL (truncated), event type count, last triggered, status indicator (green=ok, red=failed)
- Add/Edit form: name input, URL input, secret input (masked), event types multi-select checkboxes, project filter dropdown, active toggle
- Test button sends a test event and shows result inline

### Client: API Docs Page
- `ApiDocs.vue` -- renders API documentation from a static JSON/TS definition
- Each endpoint shows: method badge (GET=green, POST=blue, PUT=amber, DELETE=red), path, description, parameters table, request/response examples
- WebSocket section describes message types with JSON examples

### Styling
- Webhook list: table or card layout with `bg-[var(--theme-bg-primary)]` rows
- Status indicators: `bg-green-500` for success, `bg-red-500` for failure, `bg-gray-400` for never triggered
- Method badges: colored pills matching REST conventions
- Code examples: `bg-[var(--theme-bg-tertiary)] font-mono text-xs p-3 rounded-lg`

## Tasks
- [ ] Task 1: Add `webhooks` table creation to `apps/server/src/db.ts` with all columns (id, name, url, secret, event_types, project_filter, active, timestamps, stats)
- [ ] Task 2: Create `apps/server/src/webhooks.ts` with `triggerWebhooks(db, event)` function, `deliverWebhook()` with HMAC signature, status tracking, and timeout handling
- [ ] Task 3: Add CRUD endpoints to `apps/server/src/index.ts`: GET/POST/PUT/DELETE for `/api/webhooks` and `/api/webhooks/:id`
- [ ] Task 4: Add `POST /api/webhooks/:id/test` endpoint that sends a test event payload to the webhook URL and returns the HTTP response status
- [ ] Task 5: Integrate `triggerWebhooks()` call into the event processing pipeline in `apps/server/src/index.ts` (after insertEvent + enrichEvent, fire and forget)
- [ ] Task 6: Create `apps/client/src/components/WebhookManager.vue` with webhook list, add/edit form modal, delete confirmation, test button, and status display
- [ ] Task 7: Create `apps/client/src/data/apiDocs.ts` -- static API documentation definition object with all REST endpoints and WebSocket message types
- [ ] Task 8: Create `apps/client/src/components/ApiDocs.vue` that renders the API documentation from the static definition with method badges, parameter tables, and code examples
- [ ] Task 9: Modify `apps/client/src/App.vue` to add navigation/access to WebhookManager and ApiDocs (could be additional header buttons or future tab items)

## Files to Create/Modify
| File | Action | Description |
|------|--------|-------------|
| `apps/server/src/db.ts` | Modify | Add `webhooks` table creation |
| `apps/server/src/webhooks.ts` | Create | Webhook delivery logic with HMAC, timeout, error handling |
| `apps/server/src/index.ts` | Modify | Add webhook CRUD endpoints, test endpoint, integrate triggerWebhooks into event pipeline |
| `apps/client/src/components/WebhookManager.vue` | Create | Webhook CRUD UI with list, form, test, and status |
| `apps/client/src/data/apiDocs.ts` | Create | Static API documentation definition |
| `apps/client/src/components/ApiDocs.vue` | Create | API documentation viewer component |
| `apps/client/src/App.vue` | Modify | Add navigation to WebhookManager and ApiDocs |

## Testing
- [ ] Test 1: Creating a webhook via `POST /api/webhooks` persists it in the database and it appears in `GET /api/webhooks`
- [ ] Test 2: Updating a webhook via `PUT /api/webhooks/:id` changes the stored values
- [ ] Test 3: Deleting a webhook via `DELETE /api/webhooks/:id` removes it from the database
- [ ] Test 4: `triggerWebhooks()` sends POST request to matching webhook URL with correct headers and payload
- [ ] Test 5: Webhook with event_types filter only fires for matching event types
- [ ] Test 6: Webhook with project_filter only fires for matching source_app
- [ ] Test 7: `X-DevPulse-Signature` header contains valid HMAC-SHA256 of the payload using the webhook secret
- [ ] Test 8: Webhook delivery failure updates `last_error` and increments `failure_count`
- [ ] Test 9: `POST /api/webhooks/:id/test` returns the HTTP status from the target URL
- [ ] Test 10: ApiDocs component renders all endpoint documentation with correct method, path, and descriptions

## Definition of Done
- [ ] Code compiles without errors (both server and client)
- [ ] All acceptance criteria met
- [ ] No TypeScript errors
- [ ] Webhook delivery does not block the event processing pipeline (fire and forget with error catch)
- [ ] HMAC signature is correctly computed and verifiable by recipients
- [ ] Dark/light theme support works for all new UI components
- [ ] Webhook timeouts are enforced (no hanging requests)
